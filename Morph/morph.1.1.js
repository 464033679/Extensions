var MORPH;!function(a){var b=function(){function a(a,b){if(this.completionRatios=a,this.durationRatios=b,!(this.completionRatios instanceof Array&&this.durationRatios instanceof Array))throw"Pace: ratios not arrays";if(this.completionRatios.length!==this.durationRatios.length)throw"Pace: ratio arrays not of equal length";if(this.steps=this.completionRatios.length,0===this.steps)throw"Pace: ratio arrays cannot be empty";for(var c,d,e=-1,f=0;f<this.steps;f++){if(c=this.completionRatios[f],d=this.durationRatios[f],0>=c||0>=d)throw"Pace: ratios must be > 0";if(c>1||d>1)throw"Pace: ratios must be <= 1";if(e>=d)throw"Pace: durationRatios must be in increasing order";e=d}if(1!==c||1!==d)throw"Pace: final ratios must be 1";this.incremetalCompletionBetweenSteps=[this.completionRatios[0]],this.incremetalDurationBetweenSteps=[this.durationRatios[0]];for(var f=1;f<this.steps;f++)this.incremetalCompletionBetweenSteps.push(this.completionRatios[f]-this.completionRatios[f-1]),this.incremetalDurationBetweenSteps.push(this.durationRatios[f]-this.durationRatios[f-1]);Object.freeze(this)}return a.prototype.getCompletionMilestone=function(a){if(0>=a)return 0;if(a>=1)return 1;for(var b=0;b<this.steps&&!(a<this.durationRatios[b]);b++);var c=b>0?this.completionRatios[b-1]:0,d=b>0?this.durationRatios[b-1]:0,e=(a-d)/this.incremetalDurationBetweenSteps[b];return c+e*this.incremetalCompletionBetweenSteps[b]},a.LINEAR=new a([1],[1]),a}();a.Pace=b}(MORPH||(MORPH={}));var __extends=this.__extends||function(a,b){function d(){this.constructor=a}for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);d.prototype=b.prototype,a.prototype=new d},MORPH;!function(a){var b=function(){function b(c,d,e,f,g,h,i,j,k){if(void 0===g&&(g=0),void 0===h&&(h=null),void 0===i&&(i=null),void 0===j&&(j=null),void 0===k&&(k=a.Pace.LINEAR),this.shapeKeyGroupName=c,this._referenceStateName=d,this._endStateNames=e,this._milliDuration=f,this._millisBefore=g,this._endStateRatios=h,this.movePOV=i,this.rotatePOV=j,this._pace=k,this._startTime=-1,this._currentDurationRatio=b._COMPLETE,this._milliDuration<=0)throw"ReferenceDeformation: milliDuration must > 0";if(this._millisBefore<0)throw"ReferenceDeformation: millisBefore cannot be negative";if(!(this._endStateNames instanceof Array&&(null===this._endStateRatios||this._endStateRatios instanceof Array)))throw"ReferenceDeformation: end states / ratios not an array";var l=this._endStateNames.length;if(null!==this._endStateRatios&&this._endStateRatios.length!==l)throw"ReferenceDeformation: end states / ratios not same length";this.shapeKeyGroupName=this.shapeKeyGroupName.toUpperCase(),this._referenceStateName=this._referenceStateName.toUpperCase();for(var m=0;l>m;m++){if(this._endStateNames[m]=this._endStateNames[m].toUpperCase(),this._referenceStateName===this._endStateNames[m])throw"ReferenceDeformation: reference state cannot be the same as the end state";if(null!==this._endStateRatios&&(this._endStateRatios[m]<-1||this._endStateRatios[m]>1))throw"ReferenceDeformation: endStateRatio range  > -1 and < 1"}this.setProratedWallClocks(1)}return b.prototype.activate=function(c){void 0===c&&(c=0),this._startTime=a.Mesh.now(),c>0&&(c/=5,this._startTime-=c<this._milliDuration/10?c:this._milliDuration/10),this._currentDurationRatio=this._syncPartner?b._BLOCKED:this._proratedMillisBefore>0?b._WAITING:b._READY},b.prototype.getCompletionMilestone=function(){if(this._currentDurationRatio===b._COMPLETE)return b._COMPLETE;if(this._currentDurationRatio===b._BLOCKED){if(!this._syncPartner.isBlocked())return b._BLOCKED;this._startTime=a.Mesh.now(),this._currentDurationRatio=b._WAITING,this._syncPartner.syncReady(this._startTime)}var c=a.Mesh.now()-this._startTime;if(this._currentDurationRatio===b._WAITING){if(c-=this._proratedMillisBefore,!(c>=0))return b._WAITING;this._startTime=a.Mesh.now()-c}return this._currentDurationRatio=c/this._proratedMilliDuration,this._currentDurationRatio>b._COMPLETE&&(this._currentDurationRatio=b._COMPLETE),this._pace.getCompletionMilestone(this._currentDurationRatio)},b.prototype.resumePlay=function(){this._currentDurationRatio!==b._COMPLETE&&this._currentDurationRatio!==b._BLOCKED&&this._currentDurationRatio!==b._COMPLETE&&(this._startTime=a.Mesh.now()-this._proratedMilliDuration*this._currentDurationRatio)},b.prototype.setSyncPartner=function(a){this._syncPartner=a},b.prototype.syncReady=function(a){this._startTime=a,this._currentDurationRatio=b._WAITING},b.prototype.isBlocked=function(){return this._currentDurationRatio===b._BLOCKED},b.prototype.isComplete=function(){return this._currentDurationRatio===b._COMPLETE},b.prototype.getReferenceStateName=function(){return this._referenceStateName},b.prototype.getEndStateName=function(a){return this._endStateNames[a]},b.prototype.getEndStateNames=function(){return this._endStateNames},b.prototype.getMilliDuration=function(){return this._milliDuration},b.prototype.getMillisBefore=function(){return this._millisBefore},b.prototype.getEndStateRatio=function(a){return this._endStateRatios[a]},b.prototype.getEndStateRatios=function(){return this._endStateRatios},b.prototype.getPace=function(){return this._pace},b.prototype.getSyncPartner=function(){return this._syncPartner},b.prototype.setProratedWallClocks=function(a){this._proratedMilliDuration=this._milliDuration*a,this._proratedMillisBefore=this._millisBefore*a},Object.defineProperty(b,"BLOCKED",{get:function(){return b._BLOCKED},enumerable:!0,configurable:!0}),Object.defineProperty(b,"WAITING",{get:function(){return b._WAITING},enumerable:!0,configurable:!0}),Object.defineProperty(b,"READY",{get:function(){return b._READY},enumerable:!0,configurable:!0}),Object.defineProperty(b,"COMPLETE",{get:function(){return b._COMPLETE},enumerable:!0,configurable:!0}),b._BLOCKED=-20,b._WAITING=-10,b._READY=0,b._COMPLETE=1,b}();a.ReferenceDeformation=b;var c=function(b){function c(c,d,e,f,g,h,i,j){void 0===h&&(h=null),void 0===i&&(i=null),void 0===j&&(j=a.Pace.LINEAR),b.call(this,c,"BASIS",[d],e,f,[g],h,i,j)}return __extends(c,b),c}(b);a.Deformation=c;var d=function(a){function b(b,c,d,e){void 0===d&&(d=null),void 0===e&&(e=null),a.call(this,b,"BASIS",[],c,0,null,d,e)}return __extends(b,a),b}(b);a.DeformStall=d}(MORPH||(MORPH={}));var MORPH;!function(a){var b=function(b){function c(a,c){b.call(this,a,c),this.debug=!1,this._shapeKeyGroups=new Array,this._vertexMemberOfFaces=new Array,this._lastResumeTime=0,this._instancePaused=!1,this._clockStart=-1,this._renderCPU=0,this._totalDeformations=0,this._totalFrames=0,this._definedFacingForward=!0,this._engine=c.getEngine();var d=this;this.registerBeforeRender(function(){d.beforeRender()})}return __extends(c,b),c.prototype.beforeRender=function(){if(null!==this._positions32F&&null!==this._normals32F&&!c._systemPaused&&!this._instancePaused){var a=c.now();if(this._lastResumeTime<c._systemResumeTime){for(var d=this._shapeKeyGroups.length-1;d>=0;d--)this._shapeKeyGroups[d].resumePlay();this._lastResumeTime=c._systemResumeTime}for(var e=!1,d=this._shapeKeyGroups.length-1;d>=0;d--){var f=this._shapeKeyGroups[d].incrementallyDeform(this._positions32F,this._normals32F);e=e||f}e&&(this._clockStart<0&&this._resetTracking(a),b.prototype.updateVerticesDataDirectly.call(this,BABYLON.VertexBuffer.PositionKind,this._positions32F),b.prototype.updateVerticesDataDirectly.call(this,BABYLON.VertexBuffer.NormalKind,this._normals32F),this._renderCPU+=c.now()-a,this._totalDeformations++),this._totalFrames++}},c.prototype.resetTracking=function(){this._resetTracking(c.now())},c.prototype._resetTracking=function(a){this._clockStart=a,this._renderCPU=0,this._totalDeformations=0,this._totalFrames=0},c.prototype.getTrackingReport=function(a){void 0===a&&(a=!1);for(var b=c.now()-this._clockStart,d="\nNum Deformations: "+this._totalDeformations+"\nRender CPU milli: "+this._renderCPU.toFixed(2)+"\nRender CPU milli / Deformations: "+(this._renderCPU/this._totalDeformations).toFixed(2)+"\nWallclock milli / Deformations: "+(b/this._totalDeformations).toFixed(2)+"\nMemo, Deformations / Sec: "+(this._totalDeformations/(b/1e3)).toFixed(2)+"\nMemo, Frames with no deformation: "+(this._totalFrames-this._totalDeformations)+"\nMemo, Total vertices: "+this.getTotalVertices()+"\nShape keys:",e=0;e<this._shapeKeyGroups.length;e++)d+="\n"+this._shapeKeyGroups[e].toString();return a&&this.resetTracking(),d},c.prototype.clone=function(){return BABYLON.Tools.Error("Shared vertex instances not supported for MORPH.Mesh"),null},c.prototype.createInstance=function(){return BABYLON.Tools.Error("Shared vertex instances not supported for MORPH.Mesh"),null},c.prototype.convertToFlatShadedMesh=function(){BABYLON.Tools.Error("Flat shading not supported for MORPH.Mesh")},c.prototype.setVerticesData=function(a,c,d){b.prototype.setVerticesData.call(this,a,c,d||a===BABYLON.VertexBuffer.PositionKind||a===BABYLON.VertexBuffer.NormalKind),a===BABYLON.VertexBuffer.PositionKind?(this.originalPositions=c,this._positions32F=new Float32Array(c)):a===BABYLON.VertexBuffer.NormalKind&&(this._normals32F=new Float32Array(c))},c.prototype.setIndices=function(a){b.prototype.setIndices.call(this,a);var d,c=a.length/3,e=b.prototype.getTotalVertices.call(this),f=this.findZeroAreaFaces();f>0&&BABYLON.Tools.Warn("MORPH.Mesh: Zero area faces found:  "+f+", nFaces: "+c+", nVert "+e);for(var g=0;e>g;g++){for(var h=new Array,i=0;c>i;i++)d=3*i,(a[d]===g||a[d+1]===g||a[d+2]===g)&&h.push(i);this._vertexMemberOfFaces.push(h)}},c.prototype.findZeroAreaFaces=function(){for(var f,a=b.prototype.getIndices.call(this),c=a.length/3,d=b.prototype.getVerticesData.call(this,BABYLON.VertexBuffer.PositionKind),e=0,g=BABYLON.Vector3.Zero(),h=BABYLON.Vector3.Zero(),i=BABYLON.Vector3.Zero(),j=0;c>j;j++)f=3*j,BABYLON.Vector3.FromArrayToRef(d,3*a[f],g),BABYLON.Vector3.FromArrayToRef(d,3*a[f+1],h),BABYLON.Vector3.FromArrayToRef(d,3*a[f+2],i),(g.equals(h)||g.equals(i)||h.equals(i))&&e++;return e},c.prototype.normalsforVerticesInPlace=function(a,c,d){for(var g,h,i,j,r,e=b.prototype.getIndices.call(this),f=a.length,k=BABYLON.Vector3.Zero(),l=BABYLON.Vector3.Zero(),m=BABYLON.Vector3.Zero(),n=BABYLON.Vector3.Zero(),o=BABYLON.Vector3.Zero(),p=BABYLON.Vector3.Zero(),q=BABYLON.Vector3.Zero(),s=BABYLON.Vector3.Zero(),t=0;f>t;t++){g=this._vertexMemberOfFaces[a[t]],h=g.length,BABYLON.Vector3.FromFloatsToRef(0,0,0,s);for(var u=0;h>u;u++){if(i=3*g[u],j=this.indexOfVertInFace(e[i],e[i+1],e[i+2],a[t]),-1===j)throw"MORPH.Mesh: vertex not part of face";BABYLON.Vector3.FromFloatArrayToRef(d,3*e[i+j],k),BABYLON.Vector3.FromFloatArrayToRef(d,3*e[i+(j+1)%3],l),BABYLON.Vector3.FromFloatArrayToRef(d,3*e[i+(j+2)%3],m),k.subtractToRef(l,n),m.subtractToRef(l,o),BABYLON.Vector3.CrossToRef(n,o,p),BABYLON.Vector3.NormalizeToRef(p,q),r=p.length()/(n.length()*o.length()),-1>r?r=-1:r>1&&(r=1),q.scaleInPlace(Math.asin(r)),s.addInPlace(q)}s.normalize(),c[3*t]=s.x,c[3*t+1]=s.y,c[3*t+2]=s.z}},c.prototype.indexOfVertInFace=function(a,b,c,d){return d===a?0:d===b?1:d===c?2:-1},c.prototype.addShapeKeyGroup=function(a){this._shapeKeyGroups.push(a)},c.prototype.queueSingleEvent=function(b){this.queueEventSeries(new a.EventSeries([b]))},c.prototype.queueEventSeries=function(a){for(var b=!1,c=this._shapeKeyGroups.length-1;c>=0;c--)a.isShapeKeyGroupParticipating(this._shapeKeyGroups[c].getName())&&(this._shapeKeyGroups[c].queueEventSeries(a),b=!0);this.debug&&!b&&BABYLON.Tools.Warn("no shape keys groups participating in event series")},c.prototype.getShapeKeyGroup=function(a){for(var b=this._shapeKeyGroups.length-1;b>=0;b--)if(this._shapeKeyGroups[b].getName()===a)return this._shapeKeyGroups[b];return null},c.prototype.setDefinedFacingForward=function(a){this._definedFacingForward=a},c.prototype.movePOV=function(a,b,c){this.position.addInPlace(this.calcMovePOV(a,b,c))},c.prototype.calcMovePOV=function(a,b,c){var d=new BABYLON.Matrix,e=this.rotationQuaternion?this.rotationQuaternion:BABYLON.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);e.toRotationMatrix(d);var f=BABYLON.Vector3.Zero(),g=this._definedFacingForward?-1:1;return BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(a*g,b,c*g,d,f),f},c.prototype.rotatePOV=function(a,b,c){this.rotation.addInPlace(this.calcRotatePOV(a,b,c))},c.prototype.calcRotatePOV=function(a,b,c){var d=this._definedFacingForward?1:-1;return new BABYLON.Vector3(a*d,b,c*d)},c.pauseSystem=function(){c._systemPaused=!0},c.isSystemPaused=function(){return c._systemPaused},c.resumeSystem=function(){c._systemPaused=!1,c._systemResumeTime=c.now()},c.prototype.pausePlay=function(){this._instancePaused=!0},c.prototype.isPaused=function(){return this._instancePaused},c.prototype.resumePlay=function(){this._instancePaused=!1,this._lastResumeTime=c.now();for(var a=this._shapeKeyGroups.length-1;a>=0;a--)this._shapeKeyGroups[a].resumePlay()},c.now=function(){return"undefined"==typeof window.performance?Date.now():window.performance.now()},Object.defineProperty(c,"Version",{get:function(){return"1.1.0"},enumerable:!0,configurable:!0}),c._systemPaused=!1,c._systemResumeTime=0,c}(BABYLON.Mesh);a.Mesh=b}(MORPH||(MORPH={}));var MORPH;!function(a){var b=function(){function a(a){this.groupName=a,this._indexInRun=-99,this._highestIndexInRun=-1}return a.prototype.isReady=function(){return-1===this._indexInRun},a.prototype.runComplete=function(){return this._indexInRun>this._highestIndexInRun},a.prototype.activate=function(){this._indexInRun=-1},a}(),c=function(a){function b(b,c,d,e){a.call(this,b,e),this._target=c,this._eSeries=d}return __extends(b,a),b.prototype.execute=function(){this._target.queueEventSeries(this._eSeries)},b}(BABYLON.Action);a.EventSeriesAction=c;var d=function(){function c(c,d,e,f){void 0===d&&(d=1),void 0===e&&(e=1),void 0===f&&(f=!1),this._eventSeries=c,this._nRepeats=d,this._initialWallclockProrating=e,this._debug=f,this._groups=new Array,this._nEvents=this._eventSeries.length;for(var g=0;g<this._nEvents;g++){if(!(this._eventSeries[g]instanceof a.ReferenceDeformation||this._eventSeries[g]instanceof BABYLON.Action||"function"==typeof this._eventSeries[g]))throw"EventSeries:  eventSeries elements must either be a Deformation, Action, or function";if(this._eventSeries[g]instanceof a.ReferenceDeformation){for(var h=this._eventSeries[g].shapeKeyGroupName,i=null,j=this._groups.length-1;j>=0;j--)if(this._groups[j].groupName===h){i=this._groups[j];break}null===i&&(i=new b(h),this._groups.push(i)),i._highestIndexInRun=g}else this._groups.length>0&&(this._groups[0]._highestIndexInRun=g),this._eventSeries[g]instanceof BABYLON.Action&&this._eventSeries[g]._prepare()}if(this.nGroups=this._groups.length,0===this.nGroups)throw"EventSeries: Must have at least 1 Deformation in series.";this._debug&&1===this._nRepeats&&1!==this._initialWallclockProrating&&console.log("EventSeries: clock prorating ignored when # of repeats is 1")}return c.prototype.isShapeKeyGroupParticipating=function(a){for(var b=0;b<this.nGroups;b++)if(this._groups[b].groupName===a)return!0;return!1},c.prototype.activate=function(a){this._everyBodyReady=!0;for(var b=0;b<this.nGroups;b++)this._groups[b].groupName===a?this._groups[b].activate():this._everyBodyReady=this._everyBodyReady&&this._groups[b].isReady();this._debug&&console.log("series activated by "+a+", _everyBodyReady: "+this._everyBodyReady),this._repeatCounter=0,this._proRatingThisRepeat=this._nRepeats>1?this._initialWallclockProrating:1},c.prototype.hasMoreEvents=function(){return this._repeatCounter<this._nRepeats},c.prototype.nextEvent=function(b){if(!this._everyBodyReady)return null;for(var c,d=!1,e=!0,f=0;f<this.nGroups;f++)e=e&&this._groups[f].runComplete(),this._groups[f].groupName===b&&(c=this._groups[f],d=0===f);if(e)if(++this._repeatCounter<this._nRepeats){for(var f=0;f<this.nGroups;f++)this._groups[f].activate();1!==this._initialWallclockProrating&&(this._proRatingThisRepeat=this._initialWallclockProrating+(1-this._initialWallclockProrating)*((this._repeatCounter+1)/this._nRepeats)),this._debug&&console.log("set for repeat # "+this._repeatCounter)}else this._debug&&console.log("Series complete"),this._everyBodyReady=!1;if(c.runComplete())return null;if(c._indexInRun===c._highestIndexInRun)return c._indexInRun++,null;for(var g=c._indexInRun+1;g<this._nEvents;g++)if(this._eventSeries[g]instanceof a.ReferenceDeformation){var h=this._eventSeries[g].shapeKeyGroupName;if(c.groupName===h)return c._indexInRun=g,this._eventSeries[g].setProratedWallClocks(this._proRatingThisRepeat),this._debug&&console.log(g+" in series returned: "+h+", allGroupsRunComplete "+e+", everyBodyReady "+this._everyBodyReady),this._eventSeries[g]}else if(d)return c._indexInRun=g,this._eventSeries[g]},c}();a.EventSeries=d}(MORPH||(MORPH={}));var MORPH;!function(a){var b=function(){function b(a,b,c,d){if(this._mesh=a,this._name=b,this._states=new Array,this._normals=new Array,this._stateNames=new Array,this._queue=new Array,this._currentSeries=null,this._currentStepInSeries=null,this._endOfLastFrameTs=-1,this._reusablePositionFinals=new Array,this._reusableNormalFinals=new Array,this._lastReusablePosUsed=0,this._lastReusableNormUsed=0,this._doingRotation=!1,this._doingMovePOV=!1,this._activeLockedCamera=null,this._mirrorAxis=-1,!(c instanceof Array)||0===c.length)throw"ShapeKeyGroup: invalid affectedPositionElements arg";if(!(d instanceof Array)||d.length!==c.length)throw"ShapeKeyGroup: invalid basisState arg";this._affectedPositionElements=new Uint16Array(c),this._nPosElements=c.length;for(var e=0;e+1<this._nPosElements;e++)if(!(this._affectedPositionElements[e]<this._affectedPositionElements[e+1]))throw"ShapeKeyGroup: affectedPositionElements must be in ascending order";this._reusablePositionFinals.push(new Float32Array(this._nPosElements)),this._reusablePositionFinals.push(new Float32Array(this._nPosElements));for(var h,f=new Array,g=-1,e=0;e<this._nPosElements;e++)h=Math.floor(this._affectedPositionElements[e]/3),g!==h&&(g=h,f.push(g));this._affectedVertices=new Uint16Array(f),this._nVertices=this._affectedVertices.length,this._reusableNormalFinals.push(new Float32Array(3*this._nVertices)),this._reusableNormalFinals.push(new Float32Array(3*this._nVertices)),this.addShapeKey("BASIS",d),this._currFinalPositionVals=this._states[0],this._currFinalNormalVals=this._normals[0]}return b.prototype.getDerivedName=function(a,b,c){return a+"-["+b+"]@["+c+"]"},b.prototype.addDerivedKeyFromDeformation=function(a){this.addComboDerivedKey(a.getReferenceStateName(),a.getEndStateNames(),a.getEndStateRatios())},b.prototype.addDerivedKey=function(a,b,c){return 1===c?(BABYLON.Tools.Warn("ShapeKeyGroup: deriving a shape key where the endStateRatio is 1 is pointless, ignored"),void 0):(this.addComboDerivedKey(a,[b],[c]),void 0)},b.prototype.addComboDerivedKey=function(a,b,c){var d=this.getIdxForState(a.toUpperCase());if(-1===d)throw"ShapeKeyGroup: invalid reference state";for(var f,e=new Array,g=0;g<b.length;g++){if(f=this.getIdxForState(b[g].toUpperCase()),-1===f)throw"ShapeKeyGroup: invalid end state name: "+b[g].toUpperCase();e.push(f)}var h=this.getDerivedName(d,e,c),i=new Float32Array(this._nPosElements);this.buildPosEndPoint(i,d,e,c),this.addShapeKeyInternal(h,i)},b.prototype.addShapeKey=function(a,b){if(!(b instanceof Array)||b.length!==this._nPosElements)throw"ShapeKeyGroup: invalid stateKey arg";this.addShapeKeyInternal(a,new Float32Array(b))},b.prototype.addShapeKeyInternal=function(a,b){if("string"!=typeof a||0===a.length)throw"ShapeKeyGroup: invalid stateName arg";if(-1!==this.getIdxForState(a))return BABYLON.Tools.Warn("ShapeKeyGroup: stateName "+a+" is a duplicate, ignored"),void 0;this._states.push(b),this._stateNames.push(a);var c=new Float32Array(3*this._nVertices);this.buildNormEndPoint(c,b),this._normals.push(c),this._mesh.debug&&console.log("Shape key: "+a+" added to group: "+this._name+" on MORPH.Mesh: "+this._mesh.name)},b.prototype.incrementallyDeform=function(b,c){if(!(null!==this._currentSeries&&this._currentSeries.hasMoreEvents()||this._nextEventSeries()))return!1;for(;null===this._currentStepInSeries||this._currentStepInSeries.isComplete();){var d=this._currentSeries.nextEvent(this._name);if(null===d)return!1;d instanceof BABYLON.Action?d.execute(BABYLON.ActionEvent.CreateNew(this._mesh)):"function"==typeof d?d.call():this._nextDeformation(d)}var e=this._currentStepInSeries.getCompletionMilestone();if(0>e)return!1;if(!this._stalling){for(var f=0;f<this._nPosElements;f++)b[this._affectedPositionElements[f]]=this._priorFinalPositionVals[f]+(this._currFinalPositionVals[f]-this._priorFinalPositionVals[f])*e;for(var g,h,f=0;f<this._nVertices;f++)g=3*this._affectedVertices[f],h=3*f,c[g]=this._priorFinalNormalVals[h]+(this._currFinalNormalVals[h]-this._priorFinalNormalVals[h])*e,c[g+1]=this._priorFinalNormalVals[h+1]+(this._currFinalNormalVals[h+1]-this._priorFinalNormalVals[h+1])*e,c[g+2]=this._priorFinalNormalVals[h+2]+(this._currFinalNormalVals[h+2]-this._priorFinalNormalVals[h+2])*e;this._doingRotation&&(this._mesh.rotation=BABYLON.Vector3.Lerp(this._rotationStartVec,this._rotationEndVec,e))}if(this._doingMovePOV===!0){if(this._doingRotation){var i=this._fullAmtRight*e-this._amtRightSoFar,j=this._fullAmtUp*e-this._amtUpSoFar,k=this._fullAmtForward*e-this._amtForwardSoFar;this._mesh.movePOV(i,j,k),this._amtRightSoFar+=i,this._amtUpSoFar+=j,this._amtForwardSoFar+=k}else this._mesh.position=BABYLON.Vector3.Lerp(this._positionStartVec,this._positionEndVec,e);null!==this._activeLockedCamera&&this._activeLockedCamera._getViewMatrix()}return this._endOfLastFrameTs=a.Mesh.now(),!this._stalling},b.prototype.resumePlay=function(){null!==this._currentStepInSeries&&this._currentStepInSeries.resumePlay()},b.prototype.queueEventSeries=function(a){this._queue.push(a)},b.prototype._nextEventSeries=function(){var a=this._queue.length>0;return a&&(this._currentSeries=this._queue.shift(),this._currentSeries.activate(this._name)),a},b.prototype._nextDeformation=function(b){var c=a.Mesh.now()-this._endOfLastFrameTs;b.activate(1===this._currentSeries.nGroups&&c-this._endOfLastFrameTs<50?c:0),this._currentStepInSeries=b,this._priorFinalPositionVals=this._currFinalPositionVals,this._priorFinalNormalVals=this._currFinalNormalVals;var d=this.getIdxForState(b.getReferenceStateName());if(-1===d)throw"ShapeKeyGroup: invalid reference state";var e=b.getEndStateNames(),f=b.getEndStateRatios();if(this._stalling=null===f,!this._stalling){for(var h,g=new Array,i=!0,j=0;j<e.length;j++){if(h=this.getIdxForState(e[j].toUpperCase()),-1===h)throw"ShapeKeyGroup: invalid end state name: "+e[j].toUpperCase();if(g.push(h),f[j]<0&&-1===this._mirrorAxis)throw"ShapeKeyGroup "+this._name+": invalid deformation, negative end state ratios when not mirroring";i=i&&0===f[j]}if(i||1===f.length&&(1===f[0]||0===f[0])){var k=i||0===f[0]?d:g[0];this._currFinalPositionVals=this._states[k],this._currFinalNormalVals=this._normals[k]}else{var l=this.getIdxForState(this.getDerivedName(d,g,f));-1!==l?(this._currFinalPositionVals=this._states[l],this._currFinalNormalVals=this._normals[l]):(this._lastReusablePosUsed=1===this._lastReusablePosUsed?0:1,this.buildPosEndPoint(this._reusablePositionFinals[this._lastReusablePosUsed],d,g,f,this._mesh.debug),this._currFinalPositionVals=this._reusablePositionFinals[this._lastReusablePosUsed],this._lastReusableNormUsed=1===this._lastReusableNormUsed?0:1,this.buildNormEndPoint(this._reusableNormalFinals[this._lastReusableNormUsed],this._currFinalPositionVals),this._currFinalNormalVals=this._reusableNormalFinals[this._lastReusableNormUsed])}}if(this._doingRotation=null!==b.rotatePOV,this._doingRotation&&(this._rotationStartVec=this._mesh.rotation,this._rotationEndVec=this._rotationStartVec.add(this._mesh.calcRotatePOV(b.rotatePOV.x,b.rotatePOV.y,b.rotatePOV.z))),this._doingMovePOV=null!==b.movePOV,this._doingMovePOV&&(this._fullAmtRight=b.movePOV.x,this._amtRightSoFar=0,this._fullAmtUp=b.movePOV.y,this._amtUpSoFar=0,this._fullAmtForward=b.movePOV.z,this._amtForwardSoFar=0,this._doingRotation||(this._positionStartVec=this._mesh.position,this._positionEndVec=this._positionStartVec.add(this._mesh.calcMovePOV(this._fullAmtRight,this._fullAmtUp,this._fullAmtForward)))),this._activeLockedCamera=null,this._doingRotation||this._doingMovePOV){var m=this._mesh.getScene().activeCamera;m.lockedTarget&&m.lockedTarget===this._mesh&&(this._activeLockedCamera=m)}},b.prototype.buildPosEndPoint=function(a,b,c,d,e){void 0===e&&(e=!1);for(var h,i,j,f=this._states[b],g=c.length,k=0;k<this._nPosElements;k++){for(h=0,j=0;g>j;j++)i=(this._states[c[j]][k]-f[k])*d[j],d[j]<0&&this._mirrorAxis!==(k+1)%3&&(i*=-1),h+=i;a[k]=f[k]+h}e&&console.log(this._name+" end Point built for referenceIdx: "+b+",  endStateIdxs: "+c+", endStateRatios: "+d)},b.prototype.buildNormEndPoint=function(a,b){for(var c=new Float32Array(this._mesh.originalPositions),d=0;d<this._nPosElements;d++)c[this._affectedPositionElements[d]]=b[d];this._mesh.normalsforVerticesInPlace(this._affectedVertices,a,c)},b.prototype.getIdxForState=function(a){for(var b=this._stateNames.length-1;b>=0;b--)if(this._stateNames[b]===a)return b;return-1},b.prototype.getName=function(){return this._name},b.prototype.getNPosElements=function(){return this._nPosElements},b.prototype.getNStates=function(){return this._stateNames.length},b.prototype.toString=function(){return"ShapeKeyGroup: "+this._name+", n position elements: "+this._nPosElements+",\nStates: "+this._stateNames},b.prototype.mirrorAxisOnX=function(){this._mirrorAxis=1},b.prototype.mirrorAxisOnY=function(){this._mirrorAxis=2},b.prototype.mirrorAxisOnZ=function(){this._mirrorAxis=3},b}();a.ShapeKeyGroup=b}(MORPH||(MORPH={}));var MORPH;!function(a){var b=function(){function b(b,c,d){void 0===d&&(d=a.Pace.LINEAR),this.visemeIdx=b,this.durationIdx=c,this.pace=d,Object.freeze(this)}return b}(),c=function(){function c(b,d){void 0===d&&(d=" "),this.deformations=Array(),this.censored=Array(),this.censoredDur=Array(),this.totalDuration=0;var e=c.NORMAL_RATE,f=c.TALK,g=0,h=!1;this.deformations=new Array,this.censoringReqd=-1!==b.indexOf(c.CENSORED),this.censoringReqd&&(this.censored=new Array,this.censoredDur=new Array);for(var i=b.split(d),j=0;j<i.length;j++){var k=i[j],l=c.getLastLetterIdx(k);if(-1===l)throw"No letters found in symbol: '"+k+"'";var m=k.substring(0,l+1),n=c.ARPABET_DICT[m];if("undefined"!=typeof n){var o=k.indexOf(c.RATE);if(-1!==o)switch(k.charAt(o+1)){case"0":e=0;break;case"1":e=1;break;case"2":e=2}var p=c.SPEECH_RATE[e]*c.DURATION[n.durationIdx];"."===m&&(p=c.REST[e]),p=1.5*p;var f;if(o=k.indexOf(c.LOUDNESS),-1!==o)switch(k.charAt(o+1)){case"0":f=0;break;case"1":f=1;break;case"2":f=2}var q=[c.VISEMES[n.visemeIdx][0]*c.VOICE_LEVEL[f],c.VISEMES[n.visemeIdx][1]*c.VOICE_LEVEL[f],c.VISEMES[n.visemeIdx][2]*c.VOICE_LEVEL[f]];if(o=k.indexOf(c.MOOD),-1!==o)switch(k.charAt(o+1)){case"0":g=0;break;case"1":g=1;break;case"2":g=2;break;case"3":g=3;break;case"4":g=4;break;case"5":g=5}var r=new a.ReferenceDeformation(c._MOUTH,c._BASIS,c._MOUTH_KEYS,p,0,q,null,null,n.pace);this.deformations.push(r),this.censoringReqd&&(-1!==k.indexOf(c.CENSORED)||h?(h?-1!==k.indexOf(c.CENSORED)&&(h=!1,this.censoredDur.push(this.totalDuration+p)):(h=!0,this.censored.push(new a.ReferenceDeformation(c._MOUTH,c._BASIS,c._MOUTH_KEYS,1,0,c.VISEMES[10])),this.censoredDur.push(this.totalDuration-p)),this.censored.push(new a.DeformStall(c._MOUTH,p))):this.censored.push(r)),this.totalDuration+=p}}this.censoringReqd&&console.log("cendored dur "+this.censoredDur+", totalDuration "+this.totalDuration),Object.freeze(this)}return c.getLastLetterIdx=function(a){for(var c,b=0;b<a.length&&(c=a.charCodeAt(b),!(65>c||c>90)||46===c);b++);return b-1},c.embedAtFirstLetter=function(a,b,c){var e,d=a.indexOf("_"),f="";return-1!==d?(e=a.substring(0,d),f=a.substring(d)):e=a,d=e.indexOf(b),e=-1!==d?e.substring(0,d)+b+c+e.substring(d+2):e+b+c,e+f},c._MOUTH_KEYS=["OPEN","WIDE","UPPER"],c._BASIS="BASIS",c._MOUTH="MOUTH",c.VISEMES=[[1,.52,.267],[.962,0,.227],[1,.84,.947],[1,1,0],[.76,0,0],[0,0,.36],[1,0,1],[.067,.2,.4],[.187,1,.467],[.8,.8,0],[0,0,0]],c.ARPABET_DICT={".":new b(10,0),AA:new b(0,1),AE:new b(0,1),AH:new b(0,4),AO:new b(2,1),AW:new b(2,0),AY:new b(0,1),B:new b(7,2),CH:new b(9,1),D:new b(4,3),DH:new b(6,4),EH:new b(0,2),ER:new b(3,1),EY:new b(0,1),F:new b(5,2),G:new b(4,3),HH:new b(0,4),IH:new b(0,2),IY:new b(1,1),JH:new b(9,1),K:new b(4,2),L:new b(6,2),M:new b(7,2),N:new b(4,4),NG:new b(4,1),OW:new b(2,1),OY:new b(2,1),P:new b(7,4),R:new b(4,3),S:new b(4,2),SH:new b(9,2),T:new b(4,4),TH:new b(4,3),UH:new b(2,3),UW:new b(2,2),V:new b(5,4),W:new b(8,3),Y:new b(1,2),Z:new b(4,2),ZH:new b(9,1)},c.SPEECH_RATE=[150,100,50],c.SLOW=0,c.NORMAL_RATE=1,c.FAST=2,c.DURATION=[1.9,1.5,1,.75,.409],c.REST=[450,300,150],c.VOICE_LEVEL=[.5,.8,1],c.WHISPER=0,c.TALK=1,c.SHOUT=2,c.RATE="^",c.LOUDNESS="!",c.MOOD="+",c.CENSORED="#",c}();a.Sentence=c;var d=function(){function b(a){this.mesh=a}return b.prototype.compileAll=function(){this.compile(c.WHISPER),this.compile(c.TALK),this.compile(c.SHOUT)},b.prototype.compile=function(a){for(var b=this.mesh.getShapeKeyGroup(c._MOUTH),d=c.VISEMES.length-2;d>=0;d--){var e=[c.VISEMES[d][0]*c.VOICE_LEVEL[a],c.VISEMES[d][1]*c.VOICE_LEVEL[a],c.VISEMES[d][2]*c.VOICE_LEVEL[a]];b.addComboDerivedKey(c._BASIS,c._MOUTH_KEYS,e)}},b.prototype.say=function(b,c){void 0===c&&(c=!1),this.mesh.queueEventSeries(new a.EventSeries(!b.censoringReqd||c?b.deformations:b.censored))},b}();a.Voice=d}(MORPH||(MORPH={}));var AudioContextState;!function(a){a[a.suspended=0]="suspended",a[a.running=1]="running",a[a.closed=2]="closed"}(AudioContextState||(AudioContextState={}));var MORPH;!function(a){var b=function(){function b(){this.initialized=!1,this.playbackReady=!1,this.recording=!1,this.leftchannel=new Array,this.rightchannel=new Array,this.recorder=null,this.recordingLength=0,this.volume=null,this.audioInput=null}return b.getInstance=function(a){if(b.instance)return b.instance;b.instance=new b,b.instance.completionCallback=a?a:null;var c=window.AudioContext||window.webkitAudioContext;return c?(window.alert("Asking for audio recording permission in advance,\nto avoid asking when actually trying to record."),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia?navigator.getUserMedia({audio:!0},b.prepMic,function(b){window.alert("Error capturing audio."+b),"Undefined"!=typeof a&&a()}):window.alert("Navigator.getUserMedia not supported.")):window.alert("WebAudio not supported"),b.instance},b.prepMic=function(c){b.instance.context=new(window.AudioContext||window.webkitAudioContext),b.instance.context.sampleRate=44100,b.instance.volume=b.instance.context.createGain(),b.instance.audioInput=b.instance.context.createMediaStreamSource(c),b.instance.audioInput.connect(b.instance.volume);var d=4096;b.instance.recorder=b.instance.context.createScriptProcessor(d,2,2),b.instance.recorder.onaudioprocess=function(c){if(b.instance.recording){var e=c.inputBuffer.getChannelData(0),f=c.inputBuffer.getChannelData(1);b.instance.leftchannel.push(new Float32Array(e)),b.instance.rightchannel.push(new Float32Array(f)),b.instance.recordingLength+=d,b.instance.requestedDuration!==Number.MAX_VALUE&&a.Mesh.now()-b.instance.requestedDuration>=b.instance.startTime&&b.instance.recordStop()}},b.instance.volume.connect(b.instance.recorder),b.instance.recorder.connect(b.instance.context.destination),b.instance.initialized=!0,b.instance.completionCallback&&(b.instance.completionCallback(),b.instance.completionCallback=null)},b.prototype.recordStart=function(b,c){return void 0===b&&(b=Number.MAX_VALUE),this.recording?(BABYLON.Tools.Warn("already recording"),void 0):(this.recording=!0,this.requestedDuration=b,this.startTime=a.Mesh.now(),this.completionCallback=c?c:null,this.leftBuffer=this.rightBuffer=null,this.playbackReady=!1,void 0)},b.prototype.recordStop=function(){return this.recording?(this.recording=!1,this.leftBuffer=this.mergeBuffers(this.leftchannel),this.rightBuffer=this.mergeBuffers(this.rightchannel),this.playbackReady=!0,this.clean(),this.completionCallback&&this.completionCallback(),void 0):(BABYLON.Tools.Warn("recordStop when not recording"),void 0)
},b.prototype.mergeBuffers=function(a){for(var b=new Float32Array(this.recordingLength),c=0,d=a.length,e=0;d>e;e++){var f=a[e];b.set(f,c),c+=f.length}return b},b.prototype.clean=function(){this.objectUrl&&((window.webkitURL||window.URL).revokeObjectURL(this.objectUrl),this.objectUrl=null),this.leftchannel.length=this.rightchannel.length=0,this.recordingLength=0},b.prototype.playback=function(a){if(void 0===a&&(a=null),!this.playbackReady)return BABYLON.Tools.Warn("playback when not playbackReady"),void 0;var b=this.context.createBufferSource(),c=this.context.createBuffer(2,this.leftBuffer.length,this.context.sampleRate),d=this.embedBeep(this.leftBuffer,a),e=this.embedBeep(this.rightBuffer,a);c.getChannelData(0).set(d),c.getChannelData(1).set(e),b.buffer=c,b.connect(this.context.destination),b.start(0)},b.prototype.saveToWAV=function(a,b,c){if(void 0===b&&(b=!0),void 0===c&&(c=null),!this.playbackReady)return BABYLON.Tools.Warn("save when not playbackReady"),void 0;if(0===a.length)return window.alert("No name specified"),void 0;(a.toLowerCase().lastIndexOf(".wav")!==a.length-4||a.length<5)&&(a+=".wav");var d=new Blob([this.encodeWAV(b?2:1,c)],{type:"audio/wav"});this.objectUrl=(window.webkitURL||window.URL).createObjectURL(d);var e=window.document.createElement("a");e.href=this.objectUrl,e.download=a;var f=document.createEvent("MouseEvents");f.initEvent("click",!0,!1),e.dispatchEvent(f)},b.prototype.encodeWAV=function(a,b){var c=this.embedBeep(this.leftBuffer,b),d=2===a?this.embedBeep(this.rightBuffer,b):null,e=2===a?this.interleave(c,d):c,f=2*e.length,g=44,h=2*a,i=new ArrayBuffer(g+f),j=new DataView(i);this.writeUTFBytes(j,0,"RIFF"),j.setUint32(4,g+f,!0),this.writeUTFBytes(j,8,"WAVE"),this.writeUTFBytes(j,12,"fmt "),j.setUint32(16,16,!0),j.setUint16(20,1,!0),j.setUint16(22,a,!0),j.setUint32(24,this.context.sampleRate,!0),j.setUint32(28,this.context.sampleRate*h,!0),j.setUint16(32,h,!0),j.setUint16(34,16,!0),this.writeUTFBytes(j,36,"data"),j.setUint32(40,f,!0);for(var k=e.length,l=g,m=1,n=0;k>n;n++)j.setInt16(l,e[n]*32767*m,!0),l+=2;return j},b.prototype.embedBeep=function(a,b){if(!b)return a;for(var c=new Float32Array(a),d=0;d<b.length;d+=2){var e=Math.round(this.context.sampleRate*(b[d]/1e3)),f=Math.round(this.context.sampleRate*(b[d+1]/1e3));console.log("begin: "+e+", end "+f+", length "+a.length+", sample rate "+this.context.sampleRate);for(var g=e;f>g;g++)c[g]=0}return c},b.prototype.interleave=function(a,b){for(var c=a.length+b.length,d=new Float32Array(c),e=0,f=0;c>f;)d[f++]=a[e],d[f++]=b[e],e++;return d},b.prototype.writeUTFBytes=function(a,b,c){for(var d=c.length,e=0;d>e;e++)a.setUint8(b+e,c.charCodeAt(e))},b}();a.AudioRecorder=b}(MORPH||(MORPH={}));