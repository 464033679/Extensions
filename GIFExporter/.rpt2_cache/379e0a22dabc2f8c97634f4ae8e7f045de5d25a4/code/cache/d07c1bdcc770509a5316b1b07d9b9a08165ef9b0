{"map":"{\"version\":3,\"file\":\"gif.exporter.js\",\"sourceRoot\":\"\",\"sources\":[\"../../src/gif.exporter.ts\"],\"names\":[],\"mappings\":\"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\"}","code":"var _this = this;\r\nimport * as tslib_1 from \"tslib\";\r\nvar ENV_WORKER;\r\nvar _worker;\r\nvar worker;\r\nexport default function GIFExporter(engine, options) {\r\n    this._canvas = engine.getRenderingCanvas();\r\n    this._delay = options.delay;\r\n    this._duration = options.duration;\r\n    this._width = this._canvas.width;\r\n    this._height = this._canvas.height;\r\n    var url = URL.createObjectURL(new Blob([ENV_WORKER], { type: 'application/javascript' }));\r\n    this._worker = new Worker(ENV_WORKER);\r\n    this._holdingCanvas = document.createElement('canvas');\r\n    this._holdingCanvas2D = this._holdingCanvas.getContext('2d');\r\n    this._holdingCanvas.width = this._width;\r\n    this._holdingCanvas.height = this._height;\r\n    this._resizeCanvas = document.createElement('canvas');\r\n    this._resizeCanvas2D = this._resizeCanvas.getContext('2d');\r\n}\r\nGIFExporter.prototype.start = function () {\r\n    return new Promise(function (resolve, reject) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n        var intervalRef;\r\n        var _this = this;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            this.init();\r\n            console.log('record canvas');\r\n            intervalRef = setInterval(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                var frame, newFrame, message;\r\n                return tslib_1.__generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0: return [4 /*yield*/, this.getFrame()];\r\n                        case 1:\r\n                            frame = _a.sent();\r\n                            return [4 /*yield*/, this.flipAndRotate(new Uint8Array(frame))];\r\n                        case 2:\r\n                            newFrame = _a.sent();\r\n                            message = {\r\n                                job: 'collectFrames',\r\n                                params: {\r\n                                    frame: newFrame,\r\n                                },\r\n                            };\r\n                            this._worker.postMessage(message, [message.params.frame]);\r\n                            return [2 /*return*/];\r\n                    }\r\n                });\r\n            }); }, this._delay);\r\n            setTimeout(function () {\r\n                clearInterval(intervalRef);\r\n                var message = {\r\n                    job: 'createGIF',\r\n                    params: { width: _this._resizeCanvas.width, height: _this._resizeCanvas.height },\r\n                };\r\n                _this._worker.postMessage(message);\r\n                _this._worker.onmessage = function (_a) {\r\n                    var data = _a.data;\r\n                    console.log('complete', data);\r\n                    resolve(data);\r\n                };\r\n            }, this._duration);\r\n            return [2 /*return*/];\r\n        });\r\n    }); });\r\n};\r\nGIFExporter.prototype.stop = function () { };\r\nGIFExporter.prototype.cancle = function () { };\r\nGIFExporter.prototype.download = function (filename) {\r\n    if (filename === void 0) { filename = 'canvasGIF.gif'; }\r\n    return new Promise(function (resolve, reject) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n        var gif, url, download;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, this.start()];\r\n                case 1:\r\n                    gif = _a.sent();\r\n                    url = URL.createObjectURL(new Blob([new Uint8Array(gif)], {\r\n                        type: 'image/gif',\r\n                    }));\r\n                    download = document.getElementById('download');\r\n                    document.body.appendChild(download);\r\n                    download.target = '_blank';\r\n                    download.style.display = 'none';\r\n                    download.href = url;\r\n                    download.download = filename;\r\n                    download.click();\r\n                    download.remove();\r\n                    this._worker.terminate();\r\n                    resolve();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    }); });\r\n};\r\nGIFExporter.prototype.getFrame = function () {\r\n    return new Promise(function (resolve, reject) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n        var gl, pixels;\r\n        return tslib_1.__generator(this, function (_a) {\r\n            gl = this._canvas.getContext('webgl2') || this._canvas.getContext('webgl');\r\n            pixels = new Uint8Array(this._width * this._height * 4);\r\n            gl.readPixels(0, 0, this._width, this._height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);\r\n            resolve(pixels.buffer);\r\n            return [2 /*return*/];\r\n        });\r\n    }); });\r\n};\r\nGIFExporter.prototype.canvasSetup = function () {\r\n    _this._holdingCanvas = document.createElement('canvas');\r\n    _this._holdingCanvas2D = _this._holdingCanvas.getContext('2d');\r\n    _this._holdingCanvas.width = _this._width;\r\n    _this._holdingCanvas.height = _this._height;\r\n    _this._resizeCanvas = document.createElement('canvas');\r\n    _this._resizeCanvas2D = _this._resizeCanvas.getContext('2d');\r\n};\r\nGIFExporter.prototype.flipAndRotate = function (frame) {\r\n    return new Promise(function (resolve, reject) {\r\n        var imageData = _this._holdingCanvas2D.createImageData(_this._width, _this._height);\r\n        imageData.data.set(frame);\r\n        _this._holdingCanvas2D.putImageData(imageData, 0, 0);\r\n        _this.resize(_this._resizeCanvas);\r\n        _this.flip(_this._resizeCanvas2D, _this._holdingCanvas, _this._resizeCanvas);\r\n        var data = _this._resizeCanvas2D.getImageData(0, 0, _this._resizeCanvas.width, _this._resizeCanvas.height).data;\r\n        resolve(data.buffer);\r\n    });\r\n};\r\nGIFExporter.prototype.resize = function () {\r\n    return new Promise(function (resolve, rejct) {\r\n        var baseSize = 256;\r\n        var imageAspectRatio = _this._width / _this._height;\r\n        if (imageAspectRatio < 1) {\r\n            _this._canvas.width = baseSize * imageAspectRatio;\r\n            _this._canvas.height = baseSize;\r\n        }\r\n        else if (imageAspectRatio > 1) {\r\n            _this._canvas.width = baseSize;\r\n            _this._canvas.height = baseSize / imageAspectRatio;\r\n        }\r\n        else {\r\n            _this._canvas.width = baseSize;\r\n            _this._canvas.height = baseSize;\r\n        }\r\n        _this._canvas.width = Math.max(_this._canvas.width, 1);\r\n        _this._canvas.height = Math.max(_this._canvas.height, 1);\r\n        resolve();\r\n    });\r\n};\r\nGIFExporter.prototype.flip = function (resizeContext, holdingCanvas, resizeCanvas) {\r\n    return new Promise(function (resolve, reject) {\r\n        // Scale and draw to flip Y to reorient readPixels.\r\n        resizeContext.globalCompositeOperation = 'copy';\r\n        resizeContext.scale(1, -1); // Y flip\r\n        resizeContext.translate(0, -resizeCanvas.height); // so we can draw at 0,0\r\n        resizeContext.drawImage(holdingCanvas, 0, 0, _this._width, _this._height, 0, 0, resizeCanvas.width, resizeCanvas.height);\r\n        resizeContext.setTransform(1, 0, 0, 1, 0, 0);\r\n        resizeContext.globalCompositeOperation = 'source-over';\r\n    });\r\n};\r\n//# sourceMappingURL=gif.exporter.js.map"}
