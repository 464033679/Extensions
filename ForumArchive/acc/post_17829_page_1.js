[{"Owner":"gamestudiohx","Date":"2015-10-12T20:29:58Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_I_t_m seeing a huge performance drop on mobile browsers whenever I put a skybox on my scene_co_ even if scene is very simple. This can be seen even on BabylonJS site - Lens flares demo _lt_a href_eq__qt_http_dd_//www.babylonjs.com/?48_qt_ rel_eq__qt_external nofollow_qt__gt_http_dd_//www.babylonjs.com/?48_lt_/a_gt__lt_/p_gt__lt_p_gt_Can someone confirm this (i hope its not just me...) ?_lt_/p_gt__lt_p_gt_ThreeJS examples work perfectly on my devices_co_ this one for example _lt_a href_eq__qt_http_dd_//threejs.org/examples/#webgl_materials_envmaps_qt_ rel_eq__qt_external nofollow_qt__gt_http_dd_//threejs.org/examples/#webgl_materials_envmaps_lt_/a_gt__lt_/p_gt__lt_p_gt_ _lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"davrous","Date":"2015-10-12T20:34:39Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Hello_co__lt_/p_gt__lt_p_gt_ I don_t_t have any issue on my windows phone. Which mobile are you using? Which version of the OS and browser? Which kind if performance do you have with or without the skybox?_lt_/p_gt__lt_p_gt_Thanks_co__lt_/p_gt__lt_p_gt_David_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:05:31Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_is it still true without lens flares?_lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt_What about texture resolution? _lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt_It is almost impossible that threejs run faster than us on a so simple scene_lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt_So can you please share a scene where you see this issue?_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"gamestudiohx","Date":"2015-10-12T21:23:01Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_It looks like I judged too quickly... I_t_m actually having a problem with BablylonHx targeting android (via C++) - putting a skybox on a scene brings FPS from 60 to 4~5. So I opened both BHx and BJs lens flare example on my two android devices (4.2.1 and 4.2.2) in chrome and firefox and on one device I get 4~5FPS and on another ~10FPS. But the problem is not only in LensFlare example_co_ all of them work really bad._lt_/p_gt__lt_p_gt_However_co_ ThreeJS examples work much better_co_ this one _lt_a href_eq__qt_http_dd_//threejs.org/examples/#webgl_materials_envmaps_qt_ rel_eq__qt_external nofollow_qt__gt_http_dd_//threejs.org/examples/#webgl_materials_envmaps_lt_/a_gt_ works on constant 60FPS. _lt_/p_gt__lt_p_gt_Can someone with android device check this ?_lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt_I really don_t_t get what is killing BHx (c++) version_co_ as soon as I put a skybox GameBench is showing  99% Fragment shader load ..._lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:27:16Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_But what about the Js version of babylon? _lt_/p_gt__lt_p_gt_Are you sure that resolution is the same? perhaphs three.js uses render ratio to reduce the number of pixels to render?_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:28:52Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Is antialiasing enable on both side? is it enabled on three.js?_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"gamestudiohx","Date":"2015-10-12T21:36:02Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_I have no idea what threejs is doing but their examples are very smooth. I_t_m looking at their god-rays example and I have ~50fps._lt_/p_gt__lt_p_gt_Antialias is disabled on both_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:41:24Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt__lt_span style_eq__qt_color_dd_rgb(40_co_40_co_40)_sm_font-family_dd_helvetica_co_ arial_co_ sans-serif_sm__qt__gt_99% Fragment shader load_dd_ _lt_/span_gt_This must come from rendering resolution then. if antialising is off_co_ the resolution is too high_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:42:29Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_I saw that autoClear is turned off on threejs as well_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:45:33Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Other really important point_dd_ babylon.js compensates deviceRatio to always get a smooth rendering. try just to set engine.setHardwareScalingLevel(1.0)._lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt_I think this could help a lot_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"chg","Date":"2015-10-12T21:51:36Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_I_t_ve noticed the default shaders have a few branches to handle multiple lights/light types. It is possible that the OPs hardware is executing all the paths?_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:52:02Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Nope. these branches are removed during compilation._lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"gamestudiohx","Date":"2015-10-12T21:52:23Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_On BHx _hardwareScalingLevel is locked to 1 for all targets except js. Also the problem is not in rendering resolution or in resolution of skybox images (i_t_ve tried all kids of sizes). If I put a Layer as a background for my game then I have no problems - and the image can be even 2048px._lt_/p_gt__lt_p_gt_It looks like CubeTexture is a performance killer for BHx ?!... This is going to be a long night for me..._lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T21:56:03Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Please keep me posted if you find something_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T22:08:03Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_(Thinking out loud)_dd_ what about anisotropic? did you try setting it to 1 on your cube texture?_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T22:11:55Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Other idea!!!!_lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt_this code in the shader_dd__lt_/p_gt__lt_pre class_eq__qt_ipsCode prettyprint_qt__gt_vec3 computeReflectionCoords(float mode_co_ vec4 worldPos_co_ vec3 worldNormal){\tif (mode _eq__eq_ MAP_SPHERICAL)\t{\t\tvec3 coords _eq_ vec3(view * vec4(worldNormal_co_ 0.0))_sm_\t\treturn vec3(reflectionMatrix * vec4(coords_co_ 1.0))_sm_\t}\telse if (mode _eq__eq_ MAP_PLANAR)\t{\t\tvec3 viewDir _eq_ worldPos.xyz - vEyePosition_sm_\t\tvec3 coords _eq_ normalize(reflect(viewDir_co_ worldNormal))_sm_\t\treturn vec3(reflectionMatrix * vec4(coords_co_ 1))_sm_\t}\telse if (mode _eq__eq_ MAP_CUBIC)\t{\t\tvec3 viewDir _eq_ worldPos.xyz - vEyePosition_sm_\t\tvec3 coords _eq_ reflect(viewDir_co_ worldNormal)_sm_#ifdef INVERTCUBICMAP\t\tcoords.y _eq_ 1.0 - coords.y_sm_#endif\t\treturn vec3(reflectionMatrix * vec4(coords_co_ 0))_sm_\t}\telse if (mode _eq__eq_ MAP_PROJECTION)\t{\t\treturn vec3(reflectionMatrix * (view * worldPos))_sm_\t}\telse if (mode _eq__eq_ MAP_SKYBOX)\t{\t\treturn vPositionUVW_sm_\t}\treturn vec3(0_co_ 0_co_ 0)_sm_}_lt_/pre_gt__lt_p_gt_uses too much _qt_if_qt__lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt_Let me optimize it a bit _lt_img src_eq__qt_http_dd_//www.html5gamedevs.com/uploads/emoticons/default_smile.png_qt_ alt_eq__qt__dd_)_qt_ srcset_eq__qt_http_dd_//www.html5gamedevs.com/uploads/emoticons/smile@2x.png 2x_qt_ width_eq__qt_20_qt_ height_eq__qt_20_qt__gt__lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-12T23:03:36Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_I updated the shader relatively to reflection channel. Can you test with the new version?_lt_/p_gt__lt_p_gt_Basically I moved all reflection coordinates computation back to the vertex shader_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"gamestudiohx","Date":"2015-10-13T06:36:55Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_@deltakosh I_t_ve tried with your changes and got some improvements. Now I have ~25FPS in my game but the GPU is still on 97% (fragment load)._lt_/p_gt__lt_p_gt_I_t_ve also tried without _qt_viewDir_qt_ vector (reused coords vec) and got 2-3FPS more_dd__lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_div_gt_vec3 computeReflectionCoords(vec4 worldPos_co_ vec3 worldNormal)_lt_/div_gt__lt_div_gt_{_lt_/div_gt__lt_div_gt_#ifdef REFLECTIONMAP_SPHERICAL_lt_/div_gt__lt_div_gt_vec3 coords _eq_ vec3(view * vec4(worldNormal_co_ 0.0))_sm__lt_/div_gt__lt_div_gt_ _lt_/div_gt__lt_div_gt_return vec3(reflectionMatrix * vec4(coords_co_ 1.0))_sm__lt_/div_gt__lt_div_gt_#endif_lt_/div_gt__lt_div_gt_ _lt_/div_gt__lt_div_gt_#ifdef REFLECTIONMAP_PLANAR_lt_/div_gt__lt_div_gt_vec3 coords _eq_ worldPos.xyz - vEyePosition_sm__lt_/div_gt__lt_div_gt_coords _eq_ normalize(reflect(coords_co_ worldNormal))_sm__lt_/div_gt__lt_div_gt_ _lt_/div_gt__lt_div_gt_return vec3(reflectionMatrix * vec4(coords_co_ 1))_sm__lt_/div_gt__lt_div_gt_#endif_lt_/div_gt__lt_div_gt_ _lt_/div_gt__lt_div_gt_#ifdef REFLECTIONMAP_CUBIC_lt_/div_gt__lt_div_gt_vec3 coords _eq_ worldPos.xyz - vEyePosition_sm__lt_/div_gt__lt_div_gt_coords _eq_ reflect(coords_co_ worldNormal)_sm__lt_/div_gt__lt_div_gt_#ifdef INVERTCUBICMAP_lt_/div_gt__lt_div_gt_coords.y _eq_ 1.0 - coords.y_sm__lt_/div_gt__lt_div_gt_#endif_lt_/div_gt__lt_div_gt_return vec3(reflectionMatrix * vec4(coords_co_ 0))_sm__lt_/div_gt__lt_div_gt_#endif_lt_/div_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-13T16:39:35Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Did you use the very latest version with all the computation done in the vertex shader? _lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-13T16:40:26Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_And if you are using the skybox_co_ there is no viewdir involved_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"gamestudiohx","Date":"2015-10-13T18:29:47Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_With your latest changes I got pretty big speedup - from 5 to ~25fps but still_co_ when I remove skybox from scene I_t_m getting 60fps._lt_/p_gt__lt_p_gt_And I was trying all kinds of reflectionTexture.coordinatesMode (Texture.CUBIC_MODE too - in this case viewdir was used I guess ?!)_lt_/p_gt__lt_p_gt_Anyway_co_ its still unusable for me so I guess I_t_ll use layer as a background image for current project._lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-13T19:46:09Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_but can you confirm that you used the vertex shader based version?_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-13T19:47:01Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_I updated the lens flare demo as well. Do you still see a major framerate drop with this demo? (Do not forget to clear your cache)_lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"gamestudiohx","Date":"2015-10-13T21:09:17Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_Yes_co_ I_t_m using _lt_span style_eq__qt_color_dd_rgb(40_co_40_co_40)_sm_font-family_dd_helvetica_co_ arial_co_ sans-serif_sm__qt__gt_vertex shader based version in BHx. _lt_/span_gt__lt_/p_gt__lt_p_gt_ _lt_/p_gt__lt_p_gt__lt_span style_eq__qt_color_dd_rgb(40_co_40_co_40)_sm_font-family_dd_helvetica_co_ arial_co_ sans-serif_sm__qt__gt_And now I have 21-23fps in lens flare demo on babylonjs website (it was 10fps before)_co_ so there_t_s no _qt_major framerate drop_qt_ anymore I guess._lt_/span_gt__lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"},{"Owner":"Deltakosh","Date":"2015-10-13T21:18:45Z","Content":"_lt_div class_eq__qt_mages_qt__gt_\n\t\t\t\n_lt_p_gt_But still not 60fps _lt_img src_eq__qt_http_dd_//www.html5gamedevs.com/uploads/emoticons/default_sad.png_qt_ alt_eq__qt__dd_(_qt_ srcset_eq__qt_http_dd_//www.html5gamedevs.com/uploads/emoticons/sad@2x.png 2x_qt_ width_eq__qt_20_qt_ height_eq__qt_20_qt__gt_ The shader is super simple and I do not see where the performance is drained _lt_img src_eq__qt_http_dd_//www.html5gamedevs.com/uploads/emoticons/default_sad.png_qt_ alt_eq__qt__dd_(_qt_ srcset_eq__qt_http_dd_//www.html5gamedevs.com/uploads/emoticons/sad@2x.png 2x_qt_ width_eq__qt_20_qt_ height_eq__qt_20_qt__gt__lt_/p_gt_\n\n\n\t\t\t\n\t\t_lt_/div_gt_\n\n\t\t_lt_div class_eq__qt_ipsI_qt__gt__lt_/div_gt__lt_/div_gt_"}]