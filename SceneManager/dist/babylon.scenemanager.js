var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),BABYLON;!function(e){var t=function(){function t(e,t,n,i){if(void 0===n&&(n=!0),void 0===i&&(i={}),this.register=null,this.dispose=null,this.tick=!1,this._engine=null,this._scene=null,this._before=null,this._after=null,this._started=!1,this._initialized=!1,this._properties=null,this._handlers=null,this._manager=null,this._owned=null,null==e)throw new Error("Null owner scene obejct specified.");if(null==t)throw new Error("Null host scene obejct specified.");this.tick=n,this._owned=e,this._started=!1,this._manager=null,this._handlers={},this._initialized=!1,this._properties=i,this._engine=t.getEngine(),this._scene=t;var r=this;r.register=function(){r.registerInstance(r)},r._before=function(){r.updateInstance(r)},r._after=function(){r.afterInstance(r)},r.dispose=function(){r.disposeInstance(r)}}return Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"engine",{get:function(){return this._engine},enumerable:!0,configurable:!0}),t.prototype.start=function(){},t.prototype.update=function(){},t.prototype.after=function(){},t.prototype.destroy=function(){},Object.defineProperty(t.prototype,"manager",{get:function(){return null==this._manager&&(this._manager=e.SceneManager.GetInstance(this.scene)),this._manager},enumerable:!0,configurable:!0}),t.prototype.setProperty=function(e,t){null!=this._properties&&(this._properties[e]=t)},t.prototype.getProperty=function(e,t){void 0===t&&(t=null);var n=null;return null!=this._properties&&(n=this._properties[e]),null==n&&(n=t),null!=n?n:null},t.prototype.getMetadata=function(){return this.manager.getOwnerMetadata(this._owned)},t.prototype.onAnimationEvent=function(e,t){null!=e&&""!==e&&(this._handlers[e.toLowerCase()]=t)},t.prototype.findComponent=function(e){return this.manager.findSceneComponent(e,this._owned)},t.prototype.findComponents=function(e){return this.manager.findSceneComponents(e,this._owned)},t.prototype.findParticleSystem=function(e){return this.manager.findSceneParticleSystem(e,this._owned)},t.prototype.findParticleSystems=function(){return this.manager.findSceneParticleSystems(this._owned)},t.prototype.findLensFlareSystem=function(e){return this.manager.findSceneLensFlareSystem(e,this._owned)},t.prototype.findLensFlareSystems=function(){return this.manager.findSceneLensFlareSystems(this._owned)},t.prototype.registerInstance=function(e){e._scene.registerBeforeRender(e._before),e._scene.registerAfterRender(e._after)},t.prototype.updateInstance=function(e){e._started?e._started&&e.tick&&(e.update(),e.updateIntersectionList&&e.updateIntersectionList()):(e.start(),e._started=!0)},t.prototype.afterInstance=function(e){e._started&&e.tick&&e.after()},t.prototype.disposeInstance=function(e){e._scene.unregisterBeforeRender(e._before),e._scene.unregisterAfterRender(e._after),e.disposeSceneComponent&&e.disposeSceneComponent(),e.destroy(),e.tick=!1,e._started=!1,e._before=null,e._after=null,e._properties=null,e._handlers=null,e._engine=null,e._scene=null,e._owned=null,e._manager=null,e.register=null,e.dispose=null},t}();e.SceneComponent=t;var n=function(t){function n(e,n,i,r){void 0===i&&(i=!0),void 0===r&&(r={});var a=t.call(this,e,n,i,r)||this;return a._camera=null,a._orthoSize=0,a._orthoUpdate=!1,a._camera=e,a}return __extends(n,t),Object.defineProperty(n.prototype,"camera",{get:function(){return this._camera},enumerable:!0,configurable:!0}),n.prototype.isHighDynamicRange=function(){return this.manager.isHighDynamicRangeCamera(this._camera)},n.prototype.getRenderingPipeline=function(){return this.manager.getHighDynamicRangePipeline(this._camera)},n.prototype.setupOrthographicCamera=function(t,n){null!=this.camera&&this._camera.mode===e.Camera.ORTHOGRAPHIC_CAMERA&&(this._orthoSize=t,this.updateOrthographicSize(),this._orthoUpdate===!1&&(this._orthoUpdate=n,this._orthoUpdate===!0&&window.addEventListener("resize",this.updateOrthographicSize)))},n.prototype.updateOrthographicSize=function(){if(null!=this.camera&&0!==this._orthoSize){var e=this.scene.getEngine().getRenderingCanvasClientRect(),t=e.width/e.height,n=this._orthoSize,i=n*t;this._camera.orthoTop=n,this._camera.orthoBottom=-n,this._camera.orthoLeft=-i,this._camera.orthoRight=i}},n.prototype.disposeSceneComponent=function(){if(this._orthoUpdate===!0&&(window.removeEventListener("resize",this.updateOrthographicSize),this._orthoUpdate=!1,this._orthoSize=0),null!=this._camera.metadata&&null!=this._camera.metadata.properties&&null!=this._camera.metadata.properties.hdrPipeline){var e=this._camera.metadata.properties.hdrPipeline;e.dispose(),e=null,this._camera.metadata.properties.hdrPipeline=null}this._camera=null},n}(e.SceneComponent);e.CameraComponent=n;var i=function(e){function t(t,n,i,r){void 0===i&&(i=!0),void 0===r&&(r={});var a=e.call(this,t,n,i,r)||this;return a._light=null,a._light=t,a}return __extends(t,e),Object.defineProperty(t.prototype,"light",{get:function(){return this._light},enumerable:!0,configurable:!0}),t.prototype.disposeSceneComponent=function(){this._light=null},t}(e.SceneComponent);e.LightComponent=i;var r=function(e){function t(t,n,i,r){void 0===i&&(i=!0),void 0===r&&(r={});var a=e.call(this,t,n,i,r)||this;return a.onIntersectionEnter=null,a.onIntersectionStay=null,a.onIntersectionExit=null,a._list=[],a._mesh=null,a._collider=null,a._intersecting=!1,a._mesh=t,a._intersecting=!1,a}return __extends(t,e),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!0,configurable:!0}),t.prototype.getChildMesh=function(e,t,n){return void 0===t&&(t=!0),void 0===n&&(n=null),this.manager.getOwnerChildMesh(e,this._mesh,t,n)},t.prototype.getCollisionMesh=function(e,t){return void 0===e&&(e=!0),void 0===t&&(t=null),this.manager.getOwnerCollisionMesh(this._mesh,e,t)},t.prototype.setPhysicsCollisions=function(e,t){null!=this._mesh.physicsImpostor&&(this._mesh.physicsImpostor.onCollideEvent=this.processPhysicsCollisions),null!=this._mesh.metadata&&this._mesh.metadata.api&&(this._mesh.metadata.collisionTags=null!=e?e:[],this._mesh.metadata.collisionEvent=t)},t.prototype.clearPhysicsCollisions=function(){null!=this._mesh.physicsImpostor&&(this._mesh.physicsImpostor.onCollideEvent=null),null!=this._mesh.metadata&&this._mesh.metadata.api&&(this._mesh.metadata.collisionTags=[],this._mesh.metadata.collisionEvent=null)},t.prototype.setIntersectionMeshes=function(e){var t=this;null!=e&&e.forEach(function(e){if(null!=e){var n=t.manager.getOwnerCollisionMesh(e);null!=n&&t._list.push({mesh:n,intersecting:!1})}})},t.prototype.clearIntersectionList=function(){this._list=[]},t.prototype.updateIntersectionList=function(){var e=this;null==this._collider&&(this._collider=this.getCollisionMesh()),null!=this._collider&&null!=this._list&&this._list.length>0&&this._list.forEach(function(t){null!=t.mesh&&(e._intersecting=e._collider.intersectsMesh(t.mesh),e._intersecting?t.intersecting?null!=e.onIntersectionStay&&e.onIntersectionStay(t.mesh):null!=e.onIntersectionEnter&&e.onIntersectionEnter(t.mesh):t.intersecting&&null!=e.onIntersectionExit&&e.onIntersectionExit(t.mesh),t.intersecting=e._intersecting)})},t.prototype.processPhysicsCollisions=function(e,t){if(null!=e.object&&null!=t.object){var n=e.object;if(null!=n&&null!=n.metadata&&null!=n.metadata.collisionTags&&null!=n.metadata.collisionEvent){var i=t.object;null!=i&&null!=i.metadata&&null!=i.metadata.tagName&&(0!==n.metadata.collisionTags.length&&n.metadata.collisionTags.indexOf(i.metadata.tagName)===-1||n.metadata.collisionEvent(i))}}},t.prototype.disposeSceneComponent=function(){this.clearIntersectionList(),this.clearPhysicsCollisions(),this._collider=null,this._mesh=null},t}(e.SceneComponent);e.MeshComponent=r;var a=function(e){function t(t,n,i,r){return void 0===i&&(i=!0),void 0===r&&(r={}),e.call(this,t,n,i,r)||this}return __extends(t,e),t.prototype.ready=function(){},t}(e.MeshComponent);e.SceneController=a;var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.start=function(){var e=this;if(e.setupOrthographicCamera){var t=this.getProperty("orthoSize",5),n=this.getProperty("resizeCameras",!0);e.setupOrthographicCamera(t,n)}},t}(e.CameraComponent);e.OrthoController=o;var s=function(){function e(e){this._metadata=null,this._metadata=e}return Object.defineProperty(e.prototype,"type",{get:function(){return this._metadata.type},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"prefab",{get:function(){return this._metadata.prefab},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"objectId",{get:function(){return this._metadata.objectId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"objectName",{get:function(){return this._metadata.objectName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tagName",{get:function(){return this._metadata.tagName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"layerIndex",{get:function(){return this._metadata.layerIndex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"layerName",{get:function(){return this._metadata.layerName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"areaIndex",{get:function(){return this._metadata.areaIndex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"navAgent",{get:function(){return this._metadata.navAgent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"meshLink",{get:function(){return this._metadata.meshLink},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"meshObstacle",{get:function(){return this._metadata.meshObstacle},enumerable:!0,configurable:!0}),e.prototype.setProperty=function(e,t){null!=this._metadata.properties&&(this._metadata.properties[e]=t)},e.prototype.getProperty=function(e,t){void 0===t&&(t=null);var n=null;return null!=this._metadata.properties&&(n=this._metadata.properties[e]),null==n&&(n=t),null!=n?n:null},e}();e.ObjectMetadata=s;var l;!function(e){e[e.None=-1]="None",e[e.Generic=0]="Generic",e[e.Xbox360=1]="Xbox360"}(l=e.GamepadType||(e.GamepadType={}));var c;!function(e){e[e.Left=0]="Left",e[e.Right=1]="Right"}(c=e.JoystickButton||(e.JoystickButton={}));var u;!function(e){e[e.Left=0]="Left",e[e.Right=1]="Right"}(u=e.Xbox360Trigger||(e.Xbox360Trigger={}));var p;!function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"}(p=e.UserInputPointer||(e.UserInputPointer={}));var h;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.ClientX=2]="ClientX",e[e.ClientY=3]="ClientY",e[e.MouseX=4]="MouseX",e[e.MouseY=5]="MouseY"}(h=e.UserInputAxis||(e.UserInputAxis={}));var d;!function(e){e[e.BackSpace=8]="BackSpace",e[e.Tab=9]="Tab",e[e.Enter=13]="Enter",e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Pause=19]="Pause",e[e.Break=19]="Break",e[e.CapsLock=20]="CapsLock",e[e.Escape=27]="Escape",e[e.SpaceBar=32]="SpaceBar",e[e.PageUp=33]="PageUp",e[e.PageDown=34]="PageDown",e[e.End=35]="End",e[e.Home=36]="Home",e[e.LeftArrow=37]="LeftArrow",e[e.UpArrow=38]="UpArrow",e[e.RightArrow=39]="RightArrow",e[e.DownArrow=40]="DownArrow",e[e.Insert=45]="Insert",e[e.Delete=46]="Delete",e[e.Num0=48]="Num0",e[e.Num1=49]="Num1",e[e.Num2=50]="Num2",e[e.Num3=51]="Num3",e[e.Num4=52]="Num4",e[e.Num5=53]="Num5",e[e.Num6=54]="Num6",e[e.Num7=55]="Num7",e[e.Num8=56]="Num8",e[e.Num9=57]="Num9",e[e.A=65]="A",e[e.B=66]="B",e[e.C=67]="C",e[e.D=68]="D",e[e.E=69]="E",e[e.F=70]="F",e[e.G=71]="G",e[e.H=72]="H",e[e.I=73]="I",e[e.J=74]="J",e[e.K=75]="K",e[e.L=76]="L",e[e.M=77]="M",e[e.N=78]="N",e[e.O=79]="O",e[e.P=80]="P",e[e.Q=81]="Q",e[e.R=82]="R",e[e.S=83]="S",e[e.T=84]="T",e[e.U=85]="U",e[e.V=86]="V",e[e.W=87]="W",e[e.X=88]="X",e[e.Y=89]="Y",e[e.Z=90]="Z",e[e.LeftWindowKey=91]="LeftWindowKey",e[e.RightWindowKey=92]="RightWindowKey",e[e.SelectKey=93]="SelectKey",e[e.Numpad0=96]="Numpad0",e[e.Numpad1=97]="Numpad1",e[e.Numpad2=98]="Numpad2",e[e.Numpad3=99]="Numpad3",e[e.Numpad4=100]="Numpad4",e[e.Numpad5=101]="Numpad5",e[e.Numpad6=102]="Numpad6",e[e.Numpad7=103]="Numpad7",e[e.Numpad8=104]="Numpad8",e[e.Numpad9=105]="Numpad9",e[e.Multiply=106]="Multiply",e[e.Add=107]="Add",e[e.Subtract=109]="Subtract",e[e.DecimalPoint=110]="DecimalPoint",e[e.Divide=111]="Divide",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NumLock=144]="NumLock",e[e.ScrollLock=145]="ScrollLock",e[e.SemiColon=186]="SemiColon",e[e.EqualSign=187]="EqualSign",e[e.Comma=188]="Comma",e[e.Dash=189]="Dash",e[e.Period=190]="Period",e[e.ForwardSlash=191]="ForwardSlash",e[e.GraveAccent=192]="GraveAccent",e[e.OpenBracket=219]="OpenBracket",e[e.BackSlash=220]="BackSlash",e[e.CloseBraket=221]="CloseBraket",e[e.SingleQuote=222]="SingleQuote"}(d=e.UserInputKey||(e.UserInputKey={}));var f=function(){function e(){}return e}();f.JoystickRightHandleColor="yellow",f.JoystickLeftSensibility=1,f.JoystickRightSensibility=1,f.JoystickDeadStickValue=.01,f.GamepadDeadStickValue=.25,f.GamepadLStickXInverted=!1,f.GamepadLStickYInverted=!1,f.GamepadRStickXInverted=!1,f.GamepadRStickYInverted=!1,f.GamepadLStickSensibility=1,f.GamepadRStickSensibility=1,f.PointerAngularSensibility=1,e.UserInputOptions=f}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(t,n,i){if(this.onrender=null,this.controller=null,this._ie=!1,this._url="",this._time=0,this._timing=!1,this._filename="",this._render=null,this._running=!1,this._markup="",this._gui="None",this._input=!1,this._scene=null,this._navmesh=null,this._navigation=null,this._loadQueueIndex=0,this._loadQueueCount=0,this._loadQueueScenes=null,this._localReadyState=null,null==i)throw new Error("Null host scene obejct specified.");this._ie=!!document.all,this._url=t,this._time=0,this._timing=!1,this._filename=n,this._scene=i,this._input=!1,this._navmesh=null,this._navigation=null,this._loadQueueIndex=0,this._loadQueueCount=0,this._loadQueueScenes=null,this._localReadyState={state:"localReadyState"},this._scene._addPendingData(this._localReadyState),e.Tools.Log("Loading scene assets: "+this._filename),e.SceneManager.engine=this._scene.getEngine(),e.SceneManager.prefabs={},e.SceneManager.rightHanded=this._scene.useRightHandedSystem;var r=[];if(e.SceneManager.parseSceneCameras(this._scene.cameras,this._scene,r),e.SceneManager.parseSceneLights(this._scene.lights,this._scene,r),e.SceneManager.parseSceneMeshes(this._scene.meshes,this._scene,r),null!=this._scene.metadata&&null!=this._scene.metadata.properties){if(this._scene.metadata.properties.controllerPresent){var a=this.findSceneController();null!=a&&a instanceof e.SceneController?this.controller=a:e.Tools.Warn("Failed to locate valid BABYLON.SceneController metadata instance")}if(null!=this._scene.metadata.properties.interfaceMode&&(this._gui=this._scene.metadata.properties.interfaceMode,null!=this._scene.metadata.properties.userInterface)){var o=this._scene.metadata.properties.userInterface;window&&o.embedded&&null!=o.base64&&(this._markup=window.atob(o.base64),this._scene.metadata.properties.autoDraw===!0&&null!=this._gui&&""!==this._gui&&"None"!==this._gui&&null!=this._markup&&""!==this._markup&&this.drawSceneMarkup(this._markup))}if(null!=this._scene.metadata.properties.hasNavigationMesh&&this._scene.metadata.properties.hasNavigationMesh===!0)if(this._navmesh=this._scene.getMeshByName("sceneNavigationMesh"),null!=this._navmesh){var s=this.getNavigationTool(),l=s.buildNodes(this._navmesh);null!=l?s.setZoneData(this.getNavigationZone(),l):e.Tools.Warn("Failed to set scene navigation zone")}else e.Tools.Warn("Failed to load scene navigation mesh(s)")}r.length>0&&(r.sort(function(e,t){return e.order<t.order?-1:e.order>t.order?1:0}),r.forEach(function(e){e.instance.register()}));var c=this;this._render=function(){null!=c&&(c._timing&&null!=e.SceneManager.engine&&(c._time+=1/e.SceneManager.engine.getFps(),c._time>=Number.MAX_VALUE&&(c._time=0)),c._input&&e.SceneManager.updateUserInput(),null!=c._scene&&c._scene.render(),null!=c.onrender&&c.onrender())},this._scene.onDispose=function(){null!=c&&c.dispose()}}return t.GetInstance=function(e){return e.manager?e.manager:null},t.CreateScene=function(t,n){var i=new e.Scene(n);return e.SceneManager.parseSceneMetadata("/",t,i),i},t.LoadScene=function(t,n,i,r,a,o){var s=function(i){e.SceneManager.parseSceneMetadata(t,n,i),r&&r(i)};e.SceneLoader.Append(t,n,new e.Scene(i),s,a,o)},t.ImportMesh=function(t,n,i,r,a,o,s){var l=function(t,n,i){e.SceneManager.parseMeshMetadata(t,r),a&&a(t,n,i)};e.SceneLoader.ImportMesh(t,n,i,r,l,o,s)},t.RegisterLoader=function(t){e.SceneManager.loader=t},t.ExecuteWhenReady=function(t){e.SceneManager.ready=t},Object.defineProperty(t.prototype,"ie",{get:function(){return this._ie},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){e.SceneManager.engine=null,e.SceneManager.prefabs={},e.SceneManager.rightHanded=!0,this.disableUserInput(),this._gui=null,this._render=null,this._markup=null,this._navmesh=null,this._time=0,this._timing=!1,this._navigation=null,this.onrender=null,this.controller=null;var t=this._scene;t.manager&&(t.manager=null),t=null,this._scene=null},t.prototype.isRunning=function(){return this._running},t.prototype.isMobile=function(){var t=!1;if(null!=navigator&&null!=navigator.userAgent){var n=navigator.userAgent;(n.match(/Android/i)||n.match(/webOS/i)||n.match(/iPhone/i)||n.match(/iPad/i)||n.match(/iPod/i)||n.match(/BlackBerry/i)||n.match(/Windows Phone/i))&&(t=!0)}else e.Tools.Warn("Host navigator user agent is unavailable.");return t},t.prototype.getTime=function(){return this._time},t.prototype.enableTime=function(){this._time=0,this._timing=!0},t.prototype.disableTime=function(){this._time=0,this._timing=!1},t.prototype.loadLevel=function(t,n){if(void 0===n&&(n=null),null==e.SceneManager.loader)throw new Error("No scene loader function registered.");var i=null!=n&&""!==n?n:this.getScenePath();this.stop(),this.clearSceneMarkup(),this._scene.dispose(),e.SceneManager.loader(i,t)},t.prototype.randomNumber=function(e,t){if(e===t)return e;var n=Math.random();return n*(t-e)+e},t.prototype.importMeshes=function(t,n,i,r){void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),e.SceneManager.ImportMesh("",this.getScenePath(),t,this._scene,function(e,t,i){null!=n&&n()},i,r)},t.prototype.safeDestroy=function(e,t,n){void 0===t&&(t=5),void 0===n&&(n=!1),n&&e.setEnabled(!1),window.setTimeout(function(){e.dispose()},t)},t.prototype.getSceneName=function(){return this._filename},t.prototype.getScenePath=function(){var e="/";if(null!=this.url&&""!==this.url)e=this.url;else if(null!=this._scene.database&&null!=this._scene.database.currentSceneUrl){var t=this._scene.database.currentSceneUrl;e=t.substr(0,t.lastIndexOf("/"))+"/"}return e},t.prototype.showFullscreen=function(t){void 0===t&&(t=null);var n=null!=t?t:document.documentElement;e.Tools.RequestFullscreen(n),n.focus()},t.prototype.exitFullscreen=function(){e.Tools.ExitFullscreen()},t.prototype.getLoadingStatus=function(){var e=this._scene.getWaitingItemsCount();return e>0?"Streaming items..."+e+" remaining":"Loading scene..."},t.prototype._executeWhenReady=function(){null!=this._scene.metadata&&null!=this._scene.metadata.imports?(this._loadQueueIndex=0,this._loadQueueScenes=this._scene.metadata.imports,this._loadQueueScenes.length>0?(this._loadQueueCount=this._loadQueueScenes.length,this._loadQueueImports()):this._executeLocalReady()):this._executeLocalReady()},t.prototype._executeLocalReady=function(){if(null!=e.SceneManager.ready&&e.SceneManager.ready(this._scene,this),null!=this.controller&&this.controller.ready(),null!=this._scene.metadata&&null!=this._scene.metadata.properties&&(this._scene.metadata.properties.timeManagement===!0&&this.enableTime(),this._scene.metadata.properties.enableUserInput===!0)){var t=this._scene.metadata.properties.virtualJoystickMode;0!==t&&this._scene.metadata.properties.virtualJoystickAttached===!0&&(t=0,e.Tools.Warn("Virtual joystick camera attached, disabled manual joystick input.")),this.enableUserInput({preventDefault:this._scene.metadata.properties.preventDefault,useCapture:this._scene.metadata.properties.useCapture,enableVirtualJoystick:1===t||2===t&&this.isMobile(),disableRightStick:this._scene.metadata.properties.disableRightJoystick})}null!=this._localReadyState&&(this._scene._removePendingData(this._localReadyState),this._localReadyState=null)},t.prototype._loadQueueImports=function(){var t=this,n=this._loadQueueIndex+1;if(n>this._loadQueueCount)this._loadQueueIndex=0,this._loadQueueCount=0,this._loadQueueScenes=null,this._executeLocalReady();else{var i=this._loadQueueScenes[this._loadQueueIndex];e.Tools.Log("Importing scene meshes: "+i),this._loadQueueIndex++,this.importMeshes(i,function(){t._loadQueueImports()},null,function(n,i,r){e.Tools.Warn(i),t._loadQueueImports()})}},t.prototype.start=function(){this._running=!0,this._scene.getEngine().runRenderLoop(this._render)},t.prototype.stop=function(){this._running=!1,this._scene.getEngine().stopRenderLoop(this._render)},t.prototype.toggle=function(){this._running?(this.pauseAudio(),this.stop()):(this.resumeAudio(),this.start())},t.prototype.stepFrame=function(){this._running?this.toggle():this._render()},t.prototype.pauseAudio=function(){this._scene.audioEnabled===!0&&(this._scene.audioEnabled=!1)},t.prototype.resumeAudio=function(){this._scene.audioEnabled===!1&&(this._scene.audioEnabled=!0)},t.prototype.toggleDebug=function(e,t,n){void 0===e&&(e=!1),void 0===t&&(t=0),void 0===n&&(n=null),this._scene.debugLayer.isVisible()?this._scene.debugLayer.hide():this._scene.debugLayer.show({popup:e,initialTab:t,parentElement:n})},t.prototype.traceLights=function(){null!=this._scene.lights&&this._scene.lights.length>0&&this._scene.lights.forEach(function(t){e.Tools.Log("Trace Light: "+t.name)})},t.prototype.traceCameras=function(){null!=this._scene.cameras&&this._scene.cameras.length>0&&this._scene.cameras.forEach(function(t){e.Tools.Log("Trace Camera: "+t.name)})},t.prototype.traceMeshes=function(){null!=this._scene.meshes&&this._scene.meshes.length>0&&this._scene.meshes.forEach(function(t){e.Tools.Log("Trace Mesh: "+t.name)})},t.prototype.dumpPrefabs=function(){e.Tools.Log(e.SceneManager.prefabs)},t.prototype.getGuiMode=function(){return this._gui},t.prototype.getGuiElement=function(){return document.getElementById("gui")},t.prototype.getSceneMarkup=function(){return this._markup},t.prototype.drawSceneMarkup=function(t){if("Html"===this._gui){var n=document.getElementById("gui");if(null==n){var i=document.createElement("div");i.id="gui",i.style.width="100%",i.style.height="100%",i.style.opacity="1",i.style.zIndex="10",i.style.outline="none",i.style.backgroundColor="transparent",document.body.appendChild(i),i.innerHTML=t}else n.innerHTML=t}else e.Tools.Warn("Scene controller gui disabled.")},t.prototype.clearSceneMarkup=function(){if("Html"===this._gui){var t=document.getElementById("gui");null!=t&&(t.innerHTML="")}else e.Tools.Warn("Scene controller gui disabled.")},t.prototype.hasPrefabMesh=function(t){var n="Prefab."+t;return null!=e.SceneManager.prefabs[n]},t.prototype.getPrefabMesh=function(t){var n=null,i="Prefab."+t;return this.hasPrefabMesh(t)&&(n=e.SceneManager.prefabs[i]),n},t.prototype.instantiatePrefab=function(t,n,i,r,a,o){void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===o&&(o=null);var s=null,l="Prefab."+t;if(this.hasPrefabMesh(t)){var c=this.getPrefabMesh(t);if(null!=c)if(s=c.clone(n,o,!1,!1),null!=s){s.name=e.SceneManager.ReplaceAll(s.name,"Prefab.",""),s.parent!==o&&(s.parent=o),s.position=null!=i?i:e.Vector3.Zero(),null!=r&&(s.rotation=r),null!=a&&(s.scaling=a);var u=[s],p=s.getChildMeshes(!1);null!=p&&p.length>0&&p.forEach(function(t){t.name=e.SceneManager.ReplaceAll(t.name,"Prefab.",""),u.push(t)}),u.forEach(function(e){if(null!=e.source&&null!=e.source.skeleton){var t=e.source.skeleton.name+".Skeleton",n=t+"."+e.source.skeleton.id;e.skeleton=e.source.skeleton.clone(t,n)}}),e.SceneManager.parseMeshMetadata(u,this._scene)}else e.Tools.Warn("Failed to create prefab of: "+l);else e.Tools.Warn("Failed to lookup prefab map: "+l)}else e.Tools.Warn("Unable to locate prefab master: "+l);return s},t.prototype.playAnimation=function(e,t,n,i,r){void 0===n&&(n=!1),void 0===i&&(i=!0),void 0===r&&(r=null);var a=null,o=!1,s=this.findSceneAnimationState(e,t);if(null!=s){o=!0;var l=this._scene.beginAnimation(t,s.start,s.stop,n,s.speed,r);null!=l&&(null==a&&(a=[]),a.push(l))}if(i){var c=t.getChildMeshes(!1);if(null!=c&&c.length>0)for(var u=0;u<c.length;u++){var p=c[u],h=this.findSceneAnimationState(e,p);if(null!=h){var d=null;o===!1&&(o=!0,d=r);var f=this._scene.beginAnimation(p,h.start,h.stop,n,h.speed,d);null!=f&&(null==a&&(a=[]),a.push(f))}}}return a},t.prototype.getAnimationState=function(e,t,n){void 0===n&&(n=!0);var i=null,r=this.findSceneAnimationState(e,t);if(null!=r&&(i=r),null==i&&n){var a=t.getChildMeshes(!1);if(null!=a&&a.length>0)for(var o=0;o<a.length;o++){var s=a[o],l=this.findSceneAnimationState(e,s);if(null!=l){i=l;break}}}return i},t.prototype.getOwnerMetadata=function(t){var n=null;if(null!=t.metadata&&t.metadata.api){var i=t.metadata;n=new e.ObjectMetadata(i)}return n},t.prototype.getOwnerChildMesh=function(e,t,n,i){void 0===n&&(n=!0),void 0===i&&(i=null);var r=null,a=t.getChildMeshes(n,i);if(null!=a&&a.length>0)for(var o=0;o<a.length;o++){var s=a[o];if(s.name===e){r=s;break}}return null==r&&(r=t),r},t.prototype.getOwnerCollisionMesh=function(e,t,n){void 0===t&&(t=!0),void 0===n&&(n=null);var i=null,r=e.getChildMeshes(t,n);if(null!=r&&r.length>0)for(var a=0;a<r.length;a++){var o=r[a];if("Collider"===o.name||o.name.indexOf("_Collider")>=0||o.name.indexOf(":Collider")>=0){i=o;break}}return null==i&&(i=e),i},t.prototype.addSceneComponent=function(t,n,i,r){void 0===i&&(i=!0),void 0===r&&(r={});var a=null;if(null==n)throw new Error("Null owner scene obejct specified.");if(null==t||""===t)throw new Error("Null scene obejct klass specified.");if(null==n.metadata||!n.metadata.api){var o={api:!0,type:"Babylon",prefab:!1,objectName:"Scene Component",objectId:"0",tagName:"Untagged",layerIndex:0,layerName:"Default",areaIndex:-1,navAgent:null,meshLink:null,meshObstacle:null,animationStates:[],animationEvents:[],collisionEvent:null,collisionTags:[],components:[],properties:{}};n.metadata=o}if(null!=n.metadata&&n.metadata.api){null!=n.metadata.disposal&&n.metadata.disposal!==!1||(n.onDispose=function(){e.SceneManager.destroySceneComponents(n)},n.metadata.disposal=!0);var o=n.metadata;if(null==o.components&&(o.components=[]),null!=o.components){var s=e.Tools.Instantiate(t);if(null!=s)if(a=new s(n,this._scene,i,r),null!=a){var l={order:1e3,name:"BabylonScriptComponent",klass:t,update:i,controller:!1,properties:r,instance:a,tag:{}};o.components.push(l),a.register()}else console&&console.error("Failed to create component instance");else console&&console.error("Failed to create component class")}else console&&console.error("Failed to parse metadata components")}else console&&console.error("Null owner object metadata");return a},t.prototype.createSceneController=function(t){if(null!=this.controller)throw new Error("Scene controller already exists.");return this.controller=this.addSceneComponent(t,new e.Mesh("SceneController",this._scene)),null!=this.controller&&this.controller.ready(),this.controller},t.prototype.findSceneController=function(){var e=this._scene.meshes,t=null;if(null!=e&&e.length>0)for(var n=0;n<e.length;n++){var i=e[n];if(null!=i.metadata&&i.metadata.api){var r=i.metadata;if(null!=r.components&&r.components.length>0)for(var a=0;a<r.components.length;a++){var o=r.components[a];if(null!=o.instance&&o.controller===!0){t=o.instance;break}}}if(null!=t)break}return t},t.prototype.findSceneComponent=function(e,t){var n=null;if(null==t)throw new Error("Null owner scene obejct specified.");if(null!=t.metadata&&t.metadata.api){var i=t.metadata;if(null!=i.components&&i.components.length>0)for(var r=0;r<i.components.length;r++){var a=i.components[r];if(null!=a.instance&&a.klass===e){n=a.instance;break}}}return n},t.prototype.findSceneComponents=function(e,t){var n=[];if(null==t)throw new Error("Null owner scene obejct specified.");if(null!=t.metadata&&t.metadata.api){var i=t.metadata;if(null!=i.components&&i.components.length>0)for(var r=0;r<i.components.length;r++){var a=i.components[r];null!=a.instance&&a.klass===e&&n.push(a.instance)}}return n},t.prototype.findSceneAnimationState=function(e,t){var n=null;if(null!=t&&null!=t.metadata&&t.metadata.api){var i=t.metadata;if(null!=i.animationStates&&i.animationStates.length>0){var r=0;for(r=0;r<i.animationStates.length;r++)if(i.animationStates[r].name===e){n=i.animationStates[r];break}}}return n},t.prototype.findSceneParticleSystem=function(e,t){var n=null;if(null==t)throw new Error("Null owner scene obejct specified.");if(null!=this._scene.particleSystems&&this._scene.particleSystems.length>0)for(var i=this._scene.particleSystems.length,r=0;r<i;r++){var a=this._scene.particleSystems[r];if(a.emitter===t&&a.name===e){n=a;break}}return n},t.prototype.findSceneParticleSystems=function(e){var t=[];if(null==e)throw new Error("Null owner scene obejct specified.");return null!=this._scene.particleSystems&&this._scene.particleSystems.length>0&&this._scene.particleSystems.forEach(function(n){n.emitter===e&&t.push(n)}),t},t.prototype.findSceneLensFlareSystem=function(e,t){var n=null;if(null==t)throw new Error("Null owner scene obejct specified.");if(null!=this._scene.lensFlareSystems&&this._scene.lensFlareSystems.length>0)for(var i=this._scene.lensFlareSystems.length,r=0;r<i;r++){var a=this._scene.lensFlareSystems[r];if(a.getEmitter()===t&&a.name===e){n=a;break}}return n},t.prototype.findSceneLensFlareSystems=function(e){var t=[];if(null==e)throw new Error("Null owner scene obejct specified.");return null!=this._scene.lensFlareSystems&&this._scene.lensFlareSystems.length>0&&this._scene.lensFlareSystems.forEach(function(n){n.getEmitter()===e&&t.push(n)}),t},t.prototype.resetUserInput=function(){e.SceneManager.keymap={},e.SceneManager.clientx=0,e.SceneManager.clienty=0,e.SceneManager.mousex=0,e.SceneManager.mousey=0,e.SceneManager.vertical=0,e.SceneManager.horizontal=0,e.SceneManager.x_mousex=0,e.SceneManager.x_mousey=0,e.SceneManager.x_vertical=0,e.SceneManager.x_horizontal=0,e.SceneManager.k_mousex=0,e.SceneManager.k_mousey=0,e.SceneManager.k_vertical=0,e.SceneManager.k_horizontal=0,e.SceneManager.j_mousex=0,e.SceneManager.j_mousey=0,e.SceneManager.j_vertical=0,e.SceneManager.j_horizontal=0,e.SceneManager.g_mousex=0,e.SceneManager.g_mousey=0,e.SceneManager.g_vertical=0,e.SceneManager.g_horizontal=0,e.SceneManager.preventDefault=!1,e.SceneManager.gamepadButtonUp=[],e.SceneManager.gamepadButtonDown=[],e.SceneManager.gamepadButtonPress=[],e.SceneManager.gamepadDpadUp=[],e.SceneManager.gamepadDpadDown=[],e.SceneManager.gamepadDpadPress=[],e.SceneManager.gamepadLeftTrigger=[],e.SceneManager.gamepadRightTrigger=[],e.SceneManager.mouseButtonUp=[],e.SceneManager.mouseButtonDown=[],e.SceneManager.mouseButtonPress=[],e.SceneManager.keyButtonUp=[],e.SceneManager.keyButtonDown=[],e.SceneManager.keyButtonPress=[]},t.prototype.enableUserInput=function(t){void 0===t&&(t=null);var n=!(null==t||!t.preventDefault)&&t.preventDefault,i=!(null==t||!t.useCapture)&&t.useCapture,r=!(null==t||!t.enableVirtualJoystick)&&t.enableVirtualJoystick,a=!(null==t||!t.disableRightStick)&&t.disableRightStick,o=null!=t&&t.gamepadConnected?t.gamepadConnected:null;
this._input||(this.resetUserInput(),document.documentElement.tabIndex=1,document.documentElement.addEventListener("keyup",e.SceneManager.inputKeyUpHandler,i),document.documentElement.addEventListener("keydown",e.SceneManager.inputKeyDownHandler,i),document.documentElement.addEventListener("pointerup",e.SceneManager.inputPointerUpHandler,i),document.documentElement.addEventListener("pointerdown",e.SceneManager.inputPointerDownHandler,i),document.documentElement.addEventListener("pointermove",e.SceneManager.inputPointerMoveHandler,i),e.SceneManager.preventDefault=n,null==e.SceneManager.gamepads&&(e.SceneManager.gamepadConnected=o,e.SceneManager.gamepads=new e.Gamepads(function(t){e.SceneManager.inputGamepadConnected(t)})),e.SceneManager.virtualJoystick===!1&&(e.SceneManager.virtualJoystick=r,e.SceneManager.virtualJoystick===!0&&(null==e.SceneManager.leftJoystick&&(e.SceneManager.leftJoystick=new e.VirtualJoystick((!0)),e.SceneManager.leftJoystick.setJoystickSensibility(5*e.UserInputOptions.JoystickLeftSensibility)),a===!1&&null==e.SceneManager.rightJoystick&&(e.SceneManager.rightJoystick=new e.VirtualJoystick((!1)),e.SceneManager.rightJoystick.reverseUpDown=!0,e.SceneManager.rightJoystick.setJoystickSensibility(5*e.UserInputOptions.JoystickRightSensibility),e.SceneManager.rightJoystick.setJoystickColor(e.UserInputOptions.JoystickRightHandleColor)))),this._input=!0,document.documentElement.focus())},t.prototype.disableUserInput=function(t){void 0===t&&(t=!1),this._input&&(document.documentElement.removeEventListener("keyup",e.SceneManager.inputKeyUpHandler,t),document.documentElement.removeEventListener("keydown",e.SceneManager.inputKeyDownHandler,t),document.documentElement.removeEventListener("pointerup",e.SceneManager.inputPointerUpHandler,t),document.documentElement.removeEventListener("pointerdown",e.SceneManager.inputPointerDownHandler,t),document.documentElement.removeEventListener("pointermove",e.SceneManager.inputPointerMoveHandler,t),e.SceneManager.preventDefault=!1,this.resetUserInput(),this._input=!1)},t.prototype.getUserInput=function(t){var n=0;if(this._input)switch(t){case e.UserInputAxis.Vertical:case e.UserInputAxis.Horizontal:n=t===e.UserInputAxis.Horizontal?e.SceneManager.horizontal:e.SceneManager.vertical;break;case e.UserInputAxis.MouseX:case e.UserInputAxis.MouseY:n=t===e.UserInputAxis.MouseX?e.SceneManager.mousex:e.SceneManager.mousey;break;case e.UserInputAxis.ClientX:case e.UserInputAxis.ClientY:n=t===e.UserInputAxis.ClientX?e.SceneManager.clientx:e.SceneManager.clienty}return n},t.prototype.onKeyUp=function(t){this._input&&e.SceneManager.keyButtonUp.push(t)},t.prototype.onKeyDown=function(t){this._input&&e.SceneManager.keyButtonDown.push(t)},t.prototype.onKeyPress=function(t,n){this._input&&e.SceneManager.keyButtonPress.push({index:t,action:n})},t.prototype.getKeyInput=function(t){var n=!1;if(this._input){var i="k"+t.toString();null!=e.SceneManager.keymap[i]&&(n=e.SceneManager.keymap[i])}return n},t.prototype.onPointerUp=function(t){this._input&&e.SceneManager.mouseButtonUp.push(t)},t.prototype.onPointerDown=function(t){this._input&&e.SceneManager.mouseButtonDown.push(t)},t.prototype.onPointerPress=function(t,n){this._input&&e.SceneManager.mouseButtonPress.push({index:t,action:n})},t.prototype.getPointerInput=function(t){var n=!1;if(this._input){var i="p"+t.toString();null!=e.SceneManager.keymap[i]&&(n=e.SceneManager.keymap[i])}return n},t.prototype.onButtonUp=function(t){this._input&&e.SceneManager.gamepadButtonUp.push(t)},t.prototype.onButtonDown=function(t){this._input&&e.SceneManager.gamepadButtonDown.push(t)},t.prototype.onButtonPress=function(t,n){this._input&&e.SceneManager.gamepadButtonPress.push({index:t,action:n})},t.prototype.getButtonInput=function(t){var n=!1;if(this._input){var i="b"+t.toString();null!=e.SceneManager.keymap[i]&&(n=e.SceneManager.keymap[i])}return n},t.prototype.onDpadUp=function(t){this._input&&e.SceneManager.gamepadDpadUp.push(t)},t.prototype.onDpadDown=function(t){this._input&&e.SceneManager.gamepadDpadDown.push(t)},t.prototype.onDpadPress=function(t,n){this._input&&e.SceneManager.gamepadDpadPress.push({index:t,action:n})},t.prototype.getDpadInput=function(t){var n=!1;if(this._input){var i="d"+t.toString();null!=e.SceneManager.keymap[i]&&(n=e.SceneManager.keymap[i])}return n},t.prototype.onTriggerLeft=function(t){this._input&&e.SceneManager.gamepadLeftTrigger.push(t)},t.prototype.onTriggerRight=function(t){this._input&&e.SceneManager.gamepadRightTrigger.push(t)},t.prototype.getTriggerInput=function(t){var n=0;if(this._input){var i="t"+t.toString();null!=e.SceneManager.keymap[i]&&(n=e.SceneManager.keymap[i])}return n},t.prototype.getConnectedGamepad=function(){return this._input?e.SceneManager.gamepad:null},t.prototype.getConnectedGamepadType=function(){return this._input?e.SceneManager.gamepadType:e.GamepadType.None},t.prototype.disposeConnectedGamepad=function(){this._input&&(null!=e.SceneManager.gamepads&&(e.SceneManager.gamepads.dispose(),e.SceneManager.gamepads=null),e.SceneManager.gamepad=null,e.SceneManager.gamepadType=e.GamepadType.None,e.SceneManager.gamepadConnected=null)},t.prototype.getLeftJoystick=function(){return this._input?e.SceneManager.leftJoystick:null},t.prototype.getRightJoystick=function(){return this._input?e.SceneManager.rightJoystick:null},t.prototype.getJoystickPress=function(t){var n=!1;return this._input&&(t===e.JoystickButton.Left&&null!=e.SceneManager.leftJoystick&&e.SceneManager.leftJoystick.pressed===!0?n=!0:t===e.JoystickButton.Right&&null!=e.SceneManager.rightJoystick&&e.SceneManager.rightJoystick.pressed===!0&&(n=!0)),n},t.prototype.disposeVirtualJoysticks=function(){this._input&&(null!=e.SceneManager.leftJoystick&&(e.SceneManager.leftJoystick.releaseCanvas(),e.SceneManager.leftJoystick=null),null!=e.SceneManager.rightJoystick&&(e.SceneManager.rightJoystick.releaseCanvas(),e.SceneManager.rightJoystick=null),e.SceneManager.virtualJoystick=!1)},t.prototype.switchActiveCamera=function(e,t,n,i){if(void 0===t&&(t=!1),void 0===n&&(n=null),void 0===i&&(i=!1),e!==this._scene.activeCamera){var r=this._scene.activeCamera,a=e;t&&r.position&&(a.position=r.position.clone()),r.rotation&&(a.rotation=r.rotation.clone()),r.ellipsoid&&(a.ellipsoid=r.ellipsoid.clone()),a.fov=r.fov,a.minZ=r.minZ,a.maxZ=r.maxZ,a.checkCollisions=r.checkCollisions,a.applyGravity=r.applyGravity,a.speed=r.speed,a.postProcesses=r.postProcesses,r.postProcesses=[],null!=n&&r.detachControl(n),i===!0?r.dispose&&r.dispose():r.setEnabled&&r.setEnabled(!1),a.setEnabled&&a.setEnabled(!0),this._scene.activeCamera=a,null!=n&&this._scene.activeCamera.attachControl(n)}},t.prototype.updateCameraPosition=function(t,n,i,r){if(null!=t){var a=t._computeLocalCameraSpeed()*r,o=e.Matrix.RotationYawPitchRoll(t.rotation.y,t.rotation.x,0),s=e.Vector3.TransformCoordinates(new e.Vector3(n*a,0,-i*a),o);t.cameraDirection=t.cameraDirection.add(s)}},t.prototype.updateCameraRotation=function(t,n,i,r){null!=t&&(t.cameraRotation=t.cameraRotation.add(new e.Vector2(i*r,n*r)))},t.prototype.updateCameraUserInput=function(t,n,i){if(null!=t){var r=this.getUserInput(e.UserInputAxis.Horizontal),a=this.getUserInput(e.UserInputAxis.Vertical),o=this.getUserInput(e.UserInputAxis.MouseX),s=this.getUserInput(e.UserInputAxis.MouseY);this.updateCameraPosition(t,r,-a,n),this.updateCameraRotation(t,o,s,i)}},t.prototype.isHighDynamicRangeCamera=function(e){var t=!1;return null!=e.metadata&&e.metadata.api&&(t=null!=e.metadata.properties&&e.metadata.properties.hdr===!0),t},t.prototype.getHighDynamicRangePipeline=function(e){var t=null;return null!=e.metadata&&e.metadata.api&&null!=e.metadata.properties&&null!=e.metadata.properties.hdrPipeline&&(t=e.metadata.properties.hdrPipeline),t},t.prototype.hasNavigationMesh=function(){return null!=this._navmesh},t.prototype.setNavigationMesh=function(e){this._navmesh=e},t.prototype.getNavigationMesh=function(){return this._navmesh},t.prototype.getNavigationTool=function(){return null==this._navigation&&(this._navigation=new Navigation),this._navigation},t.prototype.getNavigationZone=function(){return"scene"},t.prototype.getNavigationPoint=function(t,n){var i=this;if(void 0===n&&(n=Number.MAX_VALUE),null==this._navmesh||null==t)return null;var r=n>100?n:100,a=(new e.Vector3(t.x,t.y+1,t.z),new e.Ray(t,new e.Vector3(0,(-1),0),r+1)),o=this._scene.pickWithRay(a,function(e){return e===i._navmesh});return o.hit&&o.pickedPoint?o.pickedPoint:null},t.prototype.getNavigationPath=function(e,t){if(null==this._navigation||null==this._navmesh)return null;var n=this.getNavigationZone(),i=this._navigation.getGroup(n,e.position);return this._navigation.findPath(e.position,t,n,i)},t.prototype.setNavigationPath=function(t,n,i,r,a){if(n&&n.length>0){for(var o=0,s=[{frame:0,value:t.position}],l=0;l<n.length;l++)o+=e.Vector3.Distance(s[l].value,n[l]),s.push({frame:o,value:n[l]});var c=new e.Animation("Move","position",3,e.Animation.ANIMATIONTYPE_VECTOR3,e.Animation.ANIMATIONLOOPMODE_CONSTANT);c.setKeys(s),t.animations.push(c),this._scene.beginAnimation(t,0,o,r,i,a)}},t.prototype.getNavigationAgent=function(t){return new e.NavigationAgent(t)},t.prototype.getNavigationAgents=function(){return this._scene.getMeshesByTags("[NAVAGENT]")},t.prototype.getNavigationAreaTable=function(){return null!=this._navmesh.metadata&&null!=this._navmesh.metadata.properties&&null!=this._navmesh.metadata.properties.table?this._navmesh.metadata.properties.table:[]},t.prototype.getNavigationAreaIndexes=function(){return null!=this._navmesh.metadata&&null!=this._navmesh.metadata.properties&&null!=this._navmesh.metadata.properties.areas?this._navmesh.metadata.properties.areas:[]},t.prototype.getNavigationAreaName=function(e){var t="";if(null!=this._navmesh.metadata&&null!=this._navmesh.metadata.properties&&null!=this._navmesh.metadata.properties.table){var n=this._navmesh.metadata.properties.table;if(null!=n)for(var i=0;i<n.length;i++)if(n[i].index===e){t=n[i].area;break}}return t},t.prototype.getNavigationAreaCost=function(e){var t=-1;if(null!=this._navmesh.metadata&&null!=this._navmesh.metadata.properties){var n=this._navmesh.metadata.properties.table;if(null!=n)for(var i=0;i<n.length;i++)if(n[i].index===e){t=n[i].cost;break}}return t},t.inputKeyDownHandler=function(t){var n="k"+t.keyCode.toString(),i=!1;switch(null!=e.SceneManager.keymap[n]&&(i=e.SceneManager.keymap[n]),e.SceneManager.keymap[n]=!0,t.keyCode){case 39:case 68:e.SceneManager.k_horizontal=1;break;case 37:case 65:e.SceneManager.k_horizontal=-1;break;case 38:case 87:e.SceneManager.k_vertical=1;break;case 40:case 83:e.SceneManager.k_vertical=-1}return null!=e.SceneManager.keyButtonDown&&e.SceneManager.keyButtonDown.length>0&&e.SceneManager.keyButtonDown.forEach(function(e){e(t.keyCode)}),i||null!=e.SceneManager.keyButtonPress&&e.SceneManager.keyButtonPress.length>0&&e.SceneManager.keyButtonPress.forEach(function(e){e.index===t.keyCode&&e.action()}),e.SceneManager.preventDefault&&t.preventDefault(),!0},t.inputKeyUpHandler=function(t){var n="k"+t.keyCode.toString();switch(e.SceneManager.keymap[n]=!1,t.keyCode){case 39:case 37:case 68:case 65:e.SceneManager.k_horizontal=0;break;case 38:case 40:case 87:case 83:e.SceneManager.k_vertical=0}return null!=e.SceneManager.keyButtonUp&&e.SceneManager.keyButtonUp.length>0&&e.SceneManager.keyButtonUp.forEach(function(e){e(t.keyCode)}),e.SceneManager.preventDefault&&t.preventDefault(),!0},t.inputPointerDownHandler=function(t){0===t.button&&(e.SceneManager.previousPosition={x:t.clientX,y:t.clientY});var n="p"+t.button.toString(),i=!1;return null!=e.SceneManager.keymap[n]&&(i=e.SceneManager.keymap[n]),e.SceneManager.keymap[n]=!0,null!=e.SceneManager.mouseButtonDown&&e.SceneManager.mouseButtonDown.length>0&&e.SceneManager.mouseButtonDown.forEach(function(e){e(t.button)}),i||null!=e.SceneManager.mouseButtonPress&&e.SceneManager.mouseButtonPress.length>0&&e.SceneManager.mouseButtonPress.forEach(function(e){e.index===t.button&&e.action()}),e.SceneManager.preventDefault&&t.preventDefault(),!0},t.inputPointerUpHandler=function(t){0===t.button&&null!=e.SceneManager.previousPosition&&(e.SceneManager.previousPosition=null,e.SceneManager.k_mousex=0,e.SceneManager.k_mousey=0);var n="p"+t.button.toString();return e.SceneManager.keymap[n]=!1,null!=e.SceneManager.mouseButtonUp&&e.SceneManager.mouseButtonUp.length>0&&e.SceneManager.mouseButtonUp.forEach(function(e){e(t.button)}),e.SceneManager.preventDefault&&t.preventDefault(),!0},t.inputPointerMoveHandler=function(t){if(e.SceneManager.virtualJoystick===!1&&null!=e.SceneManager.previousPosition){e.SceneManager.clientx=t.clientX,e.SceneManager.clienty=t.clientY;var n=t.clientX-e.SceneManager.previousPosition.x,i=t.clientY-e.SceneManager.previousPosition.y;e.SceneManager.previousPosition={x:t.clientX,y:t.clientY};var r=n*(e.UserInputOptions.PointerAngularSensibility/10),a=i*(e.UserInputOptions.PointerAngularSensibility/10);0!=r&&(e.SceneManager.k_mousex=r),0!=a&&(e.SceneManager.rightHanded?e.SceneManager.k_mousey=-a:e.SceneManager.k_mousey=a)}return e.SceneManager.preventDefault&&t.preventDefault(),!0},t.inputButtonDownHandler=function(t){if(null!=e.SceneManager.gamepad){var n="b"+t.toString(),i=!1;null!=e.SceneManager.keymap[n]&&(i=e.SceneManager.keymap[n]),e.SceneManager.keymap[n]=!0,null!=e.SceneManager.gamepadButtonDown&&e.SceneManager.gamepadButtonDown.length>0&&e.SceneManager.gamepadButtonDown.forEach(function(e){e(t)}),i||null!=e.SceneManager.gamepadButtonPress&&e.SceneManager.gamepadButtonPress.length>0&&e.SceneManager.gamepadButtonPress.forEach(function(e){e.index===t&&e.action()})}},t.inputButtonUpHandler=function(t){if(null!=e.SceneManager.gamepad){var n="b"+t.toString();e.SceneManager.keymap[n]=!1,null!=e.SceneManager.gamepadButtonUp&&e.SceneManager.gamepadButtonUp.length>0&&e.SceneManager.gamepadButtonUp.forEach(function(e){e(t)})}},t.inputXboxDPadDownHandler=function(t){if(null!=e.SceneManager.gamepad){var n="d"+t.toString(),i=!1;null!=e.SceneManager.keymap[n]&&(i=e.SceneManager.keymap[n]),e.SceneManager.keymap[n]=!0,null!=e.SceneManager.gamepadDpadDown&&e.SceneManager.gamepadDpadDown.length>0&&e.SceneManager.gamepadDpadDown.forEach(function(e){e(t)}),i||null!=e.SceneManager.gamepadDpadPress&&e.SceneManager.gamepadDpadPress.length>0&&e.SceneManager.gamepadDpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputXboxDPadUpHandler=function(t){if(null!=e.SceneManager.gamepad){var n="d"+t.toString();e.SceneManager.keymap[n]=!1,null!=e.SceneManager.gamepadDpadUp&&e.SceneManager.gamepadDpadUp.length>0&&e.SceneManager.gamepadDpadUp.forEach(function(e){e(t)})}},t.inputXboxLeftTriggerHandler=function(t){null!=e.SceneManager.gamepad&&(e.SceneManager.keymap.t0=t,null!=e.SceneManager.gamepadLeftTrigger&&e.SceneManager.gamepadLeftTrigger.length>0&&e.SceneManager.gamepadLeftTrigger.forEach(function(e){e(t)}))},t.inputXboxRightTriggerHandler=function(t){null!=e.SceneManager.gamepad&&(e.SceneManager.keymap.t1=t,null!=e.SceneManager.gamepadRightTrigger&&e.SceneManager.gamepadRightTrigger.length>0&&e.SceneManager.gamepadRightTrigger.forEach(function(e){e(t)}))},t.inputLeftStickHandler=function(t){if(null!=e.SceneManager.gamepad){var n=t,i=n.x*e.UserInputOptions.GamepadLStickSensibility,r=n.y*e.UserInputOptions.GamepadLStickSensibility;n.x=Math.abs(i)>=e.UserInputOptions.GamepadDeadStickValue?0+i:0,n.y=Math.abs(r)>=e.UserInputOptions.GamepadDeadStickValue?0+r:0,e.SceneManager.g_horizontal=e.UserInputOptions.GamepadLStickXInverted?-n.x:n.x,e.SceneManager.g_vertical=e.UserInputOptions.GamepadLStickYInverted?n.y:-n.y}},t.inputRightStickHandler=function(t){if(null!=e.SceneManager.gamepad){var n=t,i=n.x*e.UserInputOptions.GamepadRStickSensibility,r=n.y*e.UserInputOptions.GamepadRStickSensibility;n.x=Math.abs(i)>=e.UserInputOptions.GamepadDeadStickValue?0+i:0,n.y=Math.abs(r)>=e.UserInputOptions.GamepadDeadStickValue?0+r:0,e.SceneManager.g_mousex=e.UserInputOptions.GamepadRStickXInverted?-n.x:n.x,e.SceneManager.g_mousey=e.UserInputOptions.GamepadRStickYInverted?-n.y:n.y}},t.inputGamepadConnected=function(t){if(0===t.index){if(e.SceneManager.gamepad=t,e.Tools.Log("Gamepad Connected: "+e.SceneManager.gamepad.id),e.SceneManager.gamepad.id.search("Xbox 360")!==-1||e.SceneManager.gamepad.id.search("Xbox One")!==-1||e.SceneManager.gamepad.id.search("xinput")!==-1){e.SceneManager.gamepadType=e.GamepadType.Xbox360;var n=e.SceneManager.gamepad;n.onbuttonup(e.SceneManager.inputButtonUpHandler),n.onbuttondown(e.SceneManager.inputButtonDownHandler),n.onleftstickchanged(e.SceneManager.inputLeftStickHandler),n.onrightstickchanged(e.SceneManager.inputRightStickHandler),n.ondpadup(e.SceneManager.inputXboxDPadUpHandler),n.ondpaddown(e.SceneManager.inputXboxDPadDownHandler),n.onlefttriggerchanged(e.SceneManager.inputXboxLeftTriggerHandler),n.onrighttriggerchanged(e.SceneManager.inputXboxRightTriggerHandler)}else{e.SceneManager.gamepadType=e.GamepadType.Generic;var i=e.SceneManager.gamepad;i.onbuttonup(e.SceneManager.inputButtonUpHandler),i.onbuttondown(e.SceneManager.inputButtonDownHandler),i.onleftstickchanged(e.SceneManager.inputLeftStickHandler),i.onrightstickchanged(e.SceneManager.inputRightStickHandler)}null!=e.SceneManager.gamepadConnected&&e.SceneManager.gamepadConnected(e.SceneManager.gamepad,e.SceneManager.gamepadType)}},t.inputVirtualJoysticks=function(){if(null!=e.SceneManager.leftJoystick){var t=e.SceneManager.leftJoystick.deltaPosition;e.SceneManager.leftJoystick.pressed||(t=t.scale(.9));var n=t.x,i=t.y;t.x=Math.abs(n)>=e.UserInputOptions.JoystickDeadStickValue?0+n:0,t.y=Math.abs(i)>=e.UserInputOptions.JoystickDeadStickValue?0+i:0,e.SceneManager.j_horizontal=t.x,e.SceneManager.j_vertical=t.y}if(null!=e.SceneManager.rightJoystick){var r=e.SceneManager.rightJoystick.deltaPosition;e.SceneManager.rightJoystick.pressed||(r=r.scale(.9));var a=r.x,o=r.y;r.x=Math.abs(a)>=e.UserInputOptions.JoystickDeadStickValue?0+a:0,r.y=Math.abs(o)>=e.UserInputOptions.JoystickDeadStickValue?0+o:0,e.SceneManager.j_mousex=r.x,e.SceneManager.j_mousey=r.y}},t.updateUserInput=function(){e.SceneManager.inputVirtualJoysticks(),e.SceneManager.x_horizontal=0,e.SceneManager.x_vertical=0,e.SceneManager.x_mousex=0,e.SceneManager.x_mousey=0,0!==e.SceneManager.j_horizontal?e.SceneManager.x_horizontal=e.SceneManager.j_horizontal:0!==e.SceneManager.k_horizontal?e.SceneManager.x_horizontal=e.SceneManager.k_horizontal:0!==e.SceneManager.g_horizontal&&(e.SceneManager.x_horizontal=e.SceneManager.g_horizontal),0!==e.SceneManager.j_vertical?e.SceneManager.x_vertical=e.SceneManager.j_vertical:0!==e.SceneManager.k_vertical?e.SceneManager.x_vertical=e.SceneManager.k_vertical:0!==e.SceneManager.g_vertical&&(e.SceneManager.x_vertical=e.SceneManager.g_vertical),0!==e.SceneManager.j_mousex?e.SceneManager.x_mousex=e.SceneManager.j_mousex:0!==e.SceneManager.k_mousex?e.SceneManager.x_mousex=e.SceneManager.k_mousex:0!==e.SceneManager.g_mousex&&(e.SceneManager.x_mousex=e.SceneManager.g_mousex),0!==e.SceneManager.j_mousey?e.SceneManager.x_mousey=e.SceneManager.j_mousey:0!==e.SceneManager.k_mousey?e.SceneManager.x_mousey=e.SceneManager.k_mousey:0!==e.SceneManager.g_mousey&&(e.SceneManager.x_mousey=e.SceneManager.g_mousey),e.SceneManager.horizontal=e.SceneManager.x_horizontal,e.SceneManager.vertical=e.SceneManager.x_vertical,e.SceneManager.mousex=e.SceneManager.x_mousex,e.SceneManager.mousey=e.SceneManager.x_mousey},t.parseSceneMetadata=function(t,n,i){var r=i;if(null==r.manager){var a=new e.SceneManager(t,n,i);r.manager=a,r.manager._executeWhenReady()}else e.Tools.Warn("Scene already has already been parsed.")},t.parseMeshMetadata=function(t,n){var i=n;if(null!=i.manager){var r=(i.manager,[]);e.SceneManager.parseSceneMeshes(t,n,r),r.length>0&&(r.sort(function(e,t){return e.order<t.order?-1:e.order>t.order?1:0}),r.forEach(function(e){e.instance.register()}))}else e.Tools.Warn("No scene manager detected for current scene")},t.parseSceneCameras=function(t,n,i){null!=t&&t.length>0&&t.forEach(function(t){if(null!=t.metadata&&t.metadata.api){t.metadata.clone=function(){return e.SceneManager.CloneMetadata(t.metadata)},null!=t.metadata.disposal&&t.metadata.disposal!==!1||(t.onDispose=function(){e.SceneManager.destroySceneComponents(t)},t.metadata.disposal=!0);var r=t.metadata;null!=r.components&&r.components.length>0&&r.components.forEach(function(r){if(null!=r.klass&&""!==r.klass&&"BABYLON.ScriptComponent"!==r.klass&&"BABYLON.SceneController"!==r.klass&&"BABYLON.OrthoController"!==r.klass&&"BABYLON.ShaderController"!==r.klass&&"BABYLON.UniversalShaderMaterial"!==r.klass){var a=e.Tools.Instantiate(r.klass);null!=a&&(r.instance=new a(t,n,r.update,r.properties),null!=r.instance&&i.push(r))}}),e.SceneManager.setupCameraRigOptions(t,n,i),e.SceneManager.setupAnimationEvents(t,n)}})},t.parseSceneLights=function(t,n,i){null!=t&&t.length>0&&t.forEach(function(t){if(null!=t.metadata&&t.metadata.api){t.metadata.clone=function(){return e.SceneManager.CloneMetadata(t.metadata)},null!=t.metadata.disposal&&t.metadata.disposal!==!1||(t.onDispose=function(){e.SceneManager.destroySceneComponents(t)},t.metadata.disposal=!0);var r=t.metadata;null!=r.components&&r.components.length>0&&r.components.forEach(function(r){if(null!=r.klass&&""!==r.klass&&"BABYLON.ScriptComponent"!==r.klass&&"BABYLON.SceneController"!==r.klass&&"BABYLON.OrthoController"!==r.klass&&"BABYLON.ShaderController"!==r.klass&&"BABYLON.UniversalShaderMaterial"!==r.klass){var a=e.Tools.Instantiate(r.klass);null!=a&&(r.instance=new a(t,n,r.update,r.properties),null!=r.instance&&i.push(r))}}),e.SceneManager.setupAnimationEvents(t,n)}})},t.parseSceneMeshes=function(t,n,i){null!=t&&t.length>0&&t.forEach(function(t){if(null!=t.metadata&&t.metadata.api)if(t.metadata.clone=function(){return e.SceneManager.CloneMetadata(t.metadata)},t.metadata.prefab===!0)t.setEnabled(!1),e.SceneManager.prefabs[t.name]=t;else{if(null!=t.metadata.disposal&&t.metadata.disposal!==!1||(t.onDispose=function(){e.SceneManager.destroySceneComponents(t)},t.metadata.disposal=!0),null!=t.metadata.properties&&null!=t.metadata.properties.physicsTag){var r=(t.metadata.properties.physicsTag,t.metadata.properties.physicsMass),a=t.metadata.properties.physicsFriction,o=t.metadata.properties.physicsRestitution,s=t.metadata.properties.physicsImpostor,l=t.metadata.properties.physicsRotation,c=t.metadata.properties.physicsCollisions,u=t.metadata.properties.physicsEnginePlugin;t.physicsImpostor=new e.PhysicsImpostor(t,s,{mass:r,friction:a,restitution:o},n),e.SceneManager.setupPhysicsImpostor(t,u,a,c,l)}var p=t.metadata;null!=p.components&&p.components.length>0&&p.components.forEach(function(r){if(null!=r.klass&&""!==r.klass&&"BABYLON.ScriptComponent"!==r.klass&&"BABYLON.SceneController"!==r.klass&&"BABYLON.OrthoController"!==r.klass&&"BABYLON.ShaderController"!==r.klass&&"BABYLON.UniversalShaderMaterial"!==r.klass){var a=e.Tools.Instantiate(r.klass);null!=a&&(r.instance=new a(t,n,r.update,r.properties),null!=r.instance&&i.push(r))}}),e.SceneManager.setupAnimationEvents(t,n)}})},t.setupPhysicsImpostor=function(t,n,i,r,a){null!=t.physicsImpostor&&t.physicsImpostor.executeNativeFunction(function(o,s){s?0===n&&(s.linearDamping=i,s.angularDamping=i,s.collisionResponse=r,s.angularVelocity.x=0,s.angularVelocity.y=0,s.angularVelocity.z=0,s.velocity.x=0,s.velocity.y=0,s.velocity.z=0,1===a&&(s.fixedRotation=!0,s.updateMassProperties())):e.Tools.Warn("[Physics Native Function]: Null imposter body encountered for physcis mesh "+t.name+". Check physics mesh has no parent transform.")})},t.setupCameraRigOptions=function(t,n,i){if(null!=t.metadata&&null!=t.metadata.properties){if(t.mode===e.Camera.ORTHOGRAPHIC_CAMERA){var r=t.metadata.properties.orthographicSize||5,a="BABYLON.OrthoController",o=null==n.metadata||null==n.metadata.properties||!n.metadata.properties.resizeCameras||n.metadata.properties.resizeCameras,s=t.metadata;null==s.components&&(s.components=[]);var l=e.Tools.Instantiate(a);if(null!=l){var c={orthoSize:r,resizeCameras:o},u=new l(t,n,(!1),c);if(null!=u){var p={order:1e3,name:"BabylonScriptComponent",klass:a,update:!1,controller:!1,properties:c,instance:u,tag:{}};s.components.push(p),u.register()}}}if(t.metadata.properties.cameraType){var h=t.metadata.properties.cameraType;if("WebVRFreeCamera"===h||"WebVRGamepadCamera"===h){t.metadata.properties.wvrTrackPosition,t.metadata.properties.wvrPositionScale,t.metadata.properties.wvrDisplayName}else if("VRDeviceOrientationFreeCamera"===h||"VRDeviceOrientationGamepadCamera"===h){var d=t.metadata.properties.vrCameraBridge,f=t.metadata.properties.vrEyeToScreen,m=t.metadata.properties.vrInterpupillary,g=t.metadata.properties.vrScreenCenter,_=t.metadata.properties.vrVerticalRes,y=t.metadata.properties.vrHorizontalRes,v=t.metadata.properties.vrVerticalScreen,S=t.metadata.properties.vrHorizontalScreen,M=t.metadata.properties.vrLensCenterOffset,x=t.metadata.properties.vrLensSeparation,T=t.metadata.properties.vrPostProcessScale,A=t.metadata.properties.vrCompensateDistortion,b=t,E=.5-d,C=.5+d,I=e.VRCameraMetrics.GetDefault();I.eyeToScreenDistance=f,I.interpupillaryDistance=m,I.lensSeparationDistance=x,I.lensCenterOffset=M,I.hResolution=y,I.vResolution=_,I.vScreenCenter=g,I.vScreenSize=v,I.hScreenSize=S,I.postProcessScaleFactor=T,I.compensateDistortion=A,b.setCameraRigMode(e.Camera.RIG_MODE_VR,{vrCameraMetrics:I,interaxialDistance:t.interaxialDistance}),b._rigCameras[0].viewport=new e.Viewport(0,0,E,1),b._rigCameras[1].viewport=new e.Viewport(C,0,E,1),n.clearColor=new e.Color4(0,0,0,1)}}if(t.metadata.properties.hdr===!0){var R=t.metadata.properties.hdrRatio,P=t.metadata.properties.hdrExposure,L=t.metadata.properties.hdrGaussCoeff,O=t.metadata.properties.hdrGaussMean,k=t.metadata.properties.hdrGaussStandDev,N=t.metadata.properties.hdrGaussMultiplier,F=t.metadata.properties.hdrBrightThreshold,w=t.metadata.properties.hdrMinimumLuminance,U=t.metadata.properties.hdrMaximumLuminance,D=t.metadata.properties.hdrLuminanceIncrease,B=t.metadata.properties.hdrLuminanceDecrease,V=new e.HDRRenderingPipeline(t.name+"_Pipeline",n,R,null,[t]);V.exposure=P,V.gaussCoeff=L,V.gaussMean=O,V.gaussStandDev=k,V.gaussMultiplier=N,V.brightThreshold=F,V.minimumLuminance=w,V.maximumLuminance=U,V.luminanceIncreaserate=D,V.luminanceDecreaseRate=B,t.metadata.properties.hdrPipeline=V}if(t.metadata.properties.attachCanvasControl===!0){var z=t.metadata.properties.preventDefaultEvents||!1;t.attachControl(n.getEngine().getRenderingCanvas(),!z)}}},t.setupAnimationEvents=function(t,n){if(null!=t&&null!=t.metadata&&t.metadata.api){var i=t.metadata;if(null!=i.animationEvents&&i.animationEvents.length>0&&null!=i.components&&i.components.length>0){var r=e.SceneManager.locateOwnerAnimationTrack(0,t,!1);null!=r&&i.animationEvents.forEach(function(t){if(null!=t.functionName&&""!==t.functionName){var n=t.functionName.toLowerCase();r.addEvent(new e.AnimationEvent(t.frame,function(){i.components.forEach(function(e){if(null!=e.instance){var i=e.instance;if(null!=i._handlers&&i._handlers[n]){var r=i._handlers[n];r&&r(t)}}})}))}})}}},t.locateOwnerAnimationTrack=function(t,n,i,r){void 0===i&&(i=!0),void 0===r&&(r=null);var a=null;if(n instanceof e.AbstractMesh){var o=n;if(null!=o.skeleton&&null!=o.skeleton.bones&&o.skeleton.bones.length>0&&o.skeleton.bones[0]){var s=o.skeleton.bones[0];null!=s.animations&&s.animations.length>t&&null!=s.animations[t]&&(a=s.animations[t])}}if(null==a&&null!=n.animations&&n.animations.length>t&&null!=n.animations[t]&&(a=n.animations[t]),null==a&&n instanceof e.AbstractMesh){var l=n.getChildMeshes(i,r);if(null!=l&&l.length>0)for(var c=0;c<l.length;c++){var u=l[c];if(null!=u.skeleton&&null!=u.skeleton.bones&&u.skeleton.bones.length>0&&u.skeleton.bones[0]){var p=u.skeleton.bones[0];if(null!=p.animations&&p.animations.length>t&&null!=p.animations[t]){a=p.animations[t];break}}if(null==a&&null!=u.animations&&u.animations.length>0&&u.animations.length>t&&null!=u.animations[t]){a=u.animations[t];break}}}return a},t.destroySceneComponents=function(e,t){if(void 0===t&&(t=!0),null!=e&&null!=e.metadata&&e.metadata.api){var n=e.metadata;null!=n.components&&n.components.length>0&&(n.components.forEach(function(e){null!=e.instance&&(e.instance.dispose(),e.instance=null)}),t&&(e.metadata.components=null)),t&&(null!=e.metadata.properties&&(e.metadata.properties=null),null!=e.metadata.animationStates&&(e.metadata.animationStates=null),null!=e.metadata.animationEvents&&(e.metadata.animationEvents=null),null!=e.metadata.collisionEvent&&(e.metadata.collisionEvent=null),null!=e.metadata.collisionTags&&(e.metadata.collisionTags=null),e.metadata=null)}},t.ReplaceAll=function(e,t,n){return e.replace(new RegExp(t,"g"),n)},t.CloneValue=function(t,n){return t?t instanceof e.Mesh?null:t instanceof e.SubMesh?t.clone(n):t.clone?t.clone():t:null},t.CloneMetadata=function(t){var n=null;if(null!=t){var i={};e.SceneManager.DeepCopyProperties(t.properties,i);var r={};e.SceneManager.DeepCopyProperties(t.navAgent,r);var a={};e.SceneManager.DeepCopyProperties(t.meshLink,a);var o={};e.SceneManager.DeepCopyProperties(t.meshObstacle,o);var s=[];null!=t.animationStates&&t.animationStates.length>0&&t.animationStates.forEach(function(t){var n={};e.SceneManager.DeepCopyProperties(t,n),s.push(n)});null!=t.animationEvents&&t.animationEvents.length>0&&t.animationEvents.forEach(function(t){var n={};e.SceneManager.DeepCopyProperties(t,n),s.push(n)});var l=[];null!=t.components&&t.components.length>0&&t.components.forEach(function(t){var n={};e.SceneManager.DeepCopyProperties(t.properties,n),l.push({name:t.name,klass:t.klass,order:t.order,tag:t.tag,update:t.update,controller:t.controller,properties:n,instance:null})}),n={api:!0,type:t.type,prefab:!1,objectName:t.objectName,objectId:t.objectId,tagName:t.tagName,layerIndex:t.layerIndex,layerName:t.layerName,areaIndex:t.areaIndex,navAgent:r,meshLink:a,meshObstacle:o,animationStates:s,animationEvents:s,collisionEvent:null,collisionTags:[],components:l,properties:i}}return n},t.DeepCopyProperties=function(t,n,i,r){for(var a in t)if(("_"!==a[0]||r&&r.indexOf(a)!==-1)&&(!i||i.indexOf(a)===-1)){var o=t[a],s=typeof o;if("function"!==s)if("object"===s)if(o instanceof Array){if(n[a]=[],o.length>0)if("object"==typeof o[0])for(var l=0;l<o.length;l++){var c=e.SceneManager.CloneValue(o[l],n);n[a].indexOf(c)===-1&&n[a].push(c)}else n[a]=o.slice(0)}else n[a]=e.SceneManager.CloneValue(o,n);else n[a]=o}},t}();t.keymap={},t.prefabs=null,t.clientx=0,t.clienty=0,t.mousex=0,t.mousey=0,t.vertical=0,t.horizontal=0,t.x_mousex=0,t.x_mousey=0,t.x_vertical=0,t.x_horizontal=0,t.k_mousex=0,t.k_mousey=0,t.k_vertical=0,t.k_horizontal=0,t.j_mousex=0,t.j_mousey=0,t.j_vertical=0,t.j_horizontal=0,t.g_mousex=0,t.g_mousey=0,t.g_vertical=0,t.g_horizontal=0,t.engine=null,t.gamepad=null,t.gamepads=null,t.gamepadType=e.GamepadType.None,t.gamepadConnected=null,t.gamepadButtonPress=[],t.gamepadButtonDown=[],t.gamepadButtonUp=[],t.gamepadDpadPress=[],t.gamepadDpadDown=[],t.gamepadDpadUp=[],t.gamepadLeftTrigger=[],t.gamepadRightTrigger=[],t.mouseButtonPress=[],t.mouseButtonDown=[],t.mouseButtonUp=[],t.keyButtonPress=[],t.keyButtonDown=[],t.keyButtonUp=[],t.leftJoystick=null,t.rightJoystick=null,t.virtualJoystick=!1,t.previousPosition=null,t.preventDefault=!1,t.rightHanded=!0,t.loader=null,t.ready=null,e.SceneManager=t}(BABYLON||(BABYLON={}));var BABYLON;!function(e){var t=function(){function t(e){if(null==e)throw new Error("Null owner agent mesh specified.");this._mesh=e,this._info=null!=this._mesh.metadata&&null!=this._mesh.metadata.navAgent?this._mesh.metadata.navAgent:null}return Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"info",{get:function(){return this._info},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasAgentInfo",{get:function(){return null!=this.info},enumerable:!0,configurable:!0}),t.prototype.setDestination=function(t){this.hasAgentInfo||e.Tools.Warn("Null navigation agent metadata. Set agent destination ignored.")},t}();e.NavigationAgent=t;
}(BABYLON||(BABYLON={}));var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,n,i){var r,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(o=(a<3?r(o):a>3?r(t,n,o):r(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o},BABYLON;!function(e){var t=function(){function t(e,t){if(this._manager=null,null==e)throw new Error("Null owner scene obejct specified.");if(null==t)throw new Error("Null host scene obejct specified.");this._shader=e,this._manager=null}return t.prototype.start=function(){},t.prototype.update=function(){},t.prototype.define=function(e,t,n){},t.prototype.after=function(){},t.prototype.destroy=function(){},t.prototype.dispose=function(){this._shader=null,this._manager=null,this.destroy()},Object.defineProperty(t.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this._shader.getScene()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"engine",{get:function(){return this._shader.getScene().getEngine()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"manager",{get:function(){return null==this._manager&&(this._manager=e.SceneManager.GetInstance(this._shader.getScene())),this._manager},enumerable:!0,configurable:!0}),t}();e.ShaderController=t;var n=function(e){function t(){var t=e.call(this)||this;return t.ALBEDO=!1,t.AMBIENT=!1,t.AMBIENTINGRAYSCALE=!1,t.OPACITY=!1,t.OPACITYRGB=!1,t.REFLECTION=!1,t.EMISSIVE=!1,t.REFLECTIVITY=!1,t.BUMP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.SPECULAROVERALPHA=!1,t.CLIPPLANE=!1,t.ALPHATEST=!1,t.ALPHAFROMALBEDO=!1,t.POINTSIZE=!1,t.FOG=!1,t.SPECULARTERM=!1,t.OPACITYFRESNEL=!1,t.EMISSIVEFRESNEL=!1,t.FRESNEL=!1,t.NORMAL=!1,t.TANGENT=!1,t.UV1=!1,t.UV2=!1,t.VERTEXCOLOR=!1,t.VERTEXALPHA=!1,t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.INSTANCES=!1,t.MICROSURFACEFROMREFLECTIVITYMAP=!1,t.MICROSURFACEAUTOMATIC=!1,t.EMISSIVEASILLUMINATION=!1,t.LINKEMISSIVEWITHALBEDO=!1,t.LIGHTMAP=!1,t.USELIGHTMAPASSHADOWMAP=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.LOGARITHMICDEPTH=!1,t.CAMERATONEMAP=!1,t.CAMERACONTRAST=!1,t.CAMERACOLORGRADING=!1,t.CAMERACOLORCURVES=!1,t.OVERLOADEDVALUES=!1,t.OVERLOADEDSHADOWVALUES=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.REFRACTION=!1,t.REFRACTIONMAP_3D=!1,t.LINKREFRACTIONTOTRANSPARENCY=!1,t.REFRACTIONMAPINLINEARSPACE=!1,t.LODBASEDMICROSFURACE=!1,t.USEPHYSICALLIGHTFALLOFF=!1,t.RADIANCEOVERALPHA=!1,t.USEPMREMREFLECTION=!1,t.USEPMREMREFRACTION=!1,t.INVERTNORMALMAPX=!1,t.INVERTNORMALMAPY=!1,t.TWOSIDEDLIGHTING=!1,t.SHADOWFULLFLOAT=!1,t.METALLICWORKFLOW=!1,t.METALLICMAP=!1,t.ROUGHNESSSTOREINMETALMAPALPHA=!1,t.ROUGHNESSSTOREINMETALMAPGREEN=!1,t.METALLNESSSTOREINMETALMAPBLUE=!1,t.AOSTOREINMETALMAPRED=!1,t.MICROSURFACEMAP=!1,t.MORPHTARGETS=!1,t.MORPHTARGETS_NORMAL=!1,t.NUM_MORPH_INFLUENCERS=0,t.MAX_TEXTURE_IMAGE_UNITS=0,t.MAX_VERTEX_UNIFORM_VECTORS=0,t.MAX_FRAGMENT_UNIFORM_VECTORS=0,t.WEBGL_VERSION=0,t.rebuild(),t}return __extends(t,e),t}(e.MaterialDefines),i=function(t){function i(i,r,a,o,s){void 0===s&&(s=null);var l=t.call(this,i,r)||this;l.directIntensity=1,l.emissiveIntensity=1,l.environmentIntensity=1,l.specularIntensity=1,l._lightingInfos=new e.Vector4(l.directIntensity,l.emissiveIntensity,l.environmentIntensity,l.specularIntensity),l.disableBumpMap=!1,l.overloadedShadowIntensity=1,l.overloadedShadeIntensity=1,l._overloadedShadowInfos=new e.Vector4(l.overloadedShadowIntensity,l.overloadedShadeIntensity,0,0),l.cameraExposure=1,l.cameraContrast=1,l.cameraColorGradingTexture=null,l.cameraColorCurves=null,l._cameraInfos=new e.Vector4(1,1,0,0),l._microsurfaceTextureLods=new e.Vector2(0,0),l.overloadedAmbient=e.Color3.White(),l.overloadedAmbientIntensity=0,l.overloadedAlbedo=e.Color3.White(),l.overloadedAlbedoIntensity=0,l.overloadedReflectivity=new e.Color3(0,0,0),l.overloadedReflectivityIntensity=0,l.overloadedEmissive=e.Color3.White(),l.overloadedEmissiveIntensity=0,l._overloadedIntensity=new e.Vector4(l.overloadedAmbientIntensity,l.overloadedAlbedoIntensity,l.overloadedReflectivityIntensity,l.overloadedEmissiveIntensity),l.overloadedReflection=e.Color3.White(),l.overloadedReflectionIntensity=0,l.overloadedMicroSurface=0,l.overloadedMicroSurfaceIntensity=0,l._overloadedMicroSurface=new e.Vector3(l.overloadedMicroSurface,l.overloadedMicroSurfaceIntensity,l.overloadedReflectionIntensity),l.ambientTextureStrength=1,l.ambientColor=new e.Color3(0,0,0),l.albedoColor=new e.Color3(1,1,1),l.reflectivityColor=new e.Color3(1,1,1),l.reflectionColor=new e.Color3(0,0,0),l.emissiveColor=new e.Color3(0,0,0),l.microSurface=.9,l.indexOfRefraction=.66,l.invertRefractionY=!1,l.linkRefractionWithTransparency=!1,l.linkEmissiveWithAlbedo=!1,l.useLightmapAsShadowmap=!1,l.useEmissiveAsIllumination=!1,l.useAlphaFromAlbedoTexture=!1,l.useSpecularOverAlpha=!0,l.useMicroSurfaceFromReflectivityMapAlpha=!1,l.useRoughnessFromMetallicTextureAlpha=!0,l.useRoughnessFromMetallicTextureGreen=!1,l.useMetallnessFromMetallicTextureBlue=!1,l.useAmbientOcclusionFromMetallicTextureRed=!1,l.useAmbientInGrayScale=!1,l.useAutoMicroSurfaceFromReflectivityMap=!1,l.useScalarInLinearSpace=!1,l.usePhysicalLightFalloff=!0,l.useRadianceOverAlpha=!0,l.useParallax=!1,l.useParallaxOcclusion=!1,l.parallaxScaleBias=.05,l.disableLighting=!1,l.maxSimultaneousLights=4,l.invertNormalMapX=!1,l.invertNormalMapY=!1,l.twoSidedLighting=!1,l._renderTargets=new e.SmartArray(16),l._worldViewProjectionMatrix=e.Matrix.Zero(),l._globalAmbientColor=new e.Color3(0,0,0),l._tempColor=new e.Color3,l._defines=new n,l._cachedDefines=new n,l._textures={},l._textureArrays={},l._floats={},l._floatsArrays={},l._colors3={},l._colors4={},l._vectors2={},l._vectors3={},l._vectors4={},l._matrices={},l._matrices3x3={},l._matrices2x2={},l._vectors3Arrays={},l._cachedWorldViewMatrix=new e.Matrix,l._controller=null,l._started=!1,l._instance=null,l._register=null,l._before=null,l._after=null,l._dispose=null,l._webglVersion=0,l._maxTexturesImageUnits=0,l._maxVertexUniformVectors=0,l._maxFragmentUniformVectors=0,l._myScene=null,l._myShadowGenerator=null,l._started=!1,l._instance=null,l._controller=s,l._shaderPath=a,l._cachedDefines.BonesPerMesh=-1;var c=r.getEngine(),u=c.getCaps();l._webglVersion=c.webGLVersion,l._maxTexturesImageUnits=u.maxTexturesImageUnits,l._maxVertexUniformVectors=u.maxVertexUniformVectors,l._maxFragmentUniformVectors=u.maxFragmentUniformVectors;var p=["world","view","projection","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vEmissiveColor","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoScale","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vReflectivityInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","depthValues","opacityParts","emissiveLeftColor","emissiveRightColor","vLightingIntensity","vOverloadedShadowIntensity","vOverloadedIntensity","vOverloadedAlbedo","vOverloadedReflection","vOverloadedReflectivity","vOverloadedEmissive","vOverloadedMicroSurface","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX","vSphericalYY","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vMicrosurfaceTextureLods","vCameraInfos"],h=["albedoSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","reflectivitySampler","bumpSampler","microSurfaceSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"],d=0;if(o.needAlphaBlending=o.needAlphaBlending||!1,o.needAlphaTesting=o.needAlphaTesting||!1,o.attributes=o.attributes||["position","normal","uv"],o.uniforms=o.uniforms||["worldViewProjection"],o.samplers=o.samplers||[],o.defines=o.defines||[],l._options=o,p.length>0)for(d=0;d<p.length;d++)l._checkUniform(p[d]);if(h.length>0)for(d=0;d<h.length;d++)l._checkSampler(h[d]);if(l.getRenderTargetTextures=function(){return l._renderTargets.reset(),l.reflectionTexture&&l.reflectionTexture.isRenderTarget&&l._renderTargets.push(l.reflectionTexture),l.refractionTexture&&l.refractionTexture.isRenderTarget&&l._renderTargets.push(l.refractionTexture),l._renderTargets},l._controller&&""!==l._controller&&"BABYLON.UniversalShaderMaterial"!==l._controller&&"BABYLON.ShaderController"!==l._controller&&"BABYLON.ParticleSystem"!==l._controller){var f=e.Tools.Instantiate(l._controller);null!=f?l._instance=new f(l,r):e.Tools.Warn("Failed to load shader controller class: "+l.controller)}var m=l;return m._register=function(){m.registerInstance(m)},m._before=function(){m.updateInstance(m)},m._after=function(){m.afterInstance(m)},m._dispose=function(){m.disposeInstance(m)},m._register(),l}return __extends(i,t),Object.defineProperty(i.prototype,"options",{get:function(){return this._options},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"controller",{get:function(){return this._controller},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"textures",{get:function(){return this._textures},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"textureArray",{get:function(){return this._textureArrays},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"floats",{get:function(){return this._floats},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"floatsArrays",{get:function(){return this._floatsArrays},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"colors3",{get:function(){return this._colors3},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"colors4",{get:function(){return this._colors4},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"vectors2",{get:function(){return this._vectors2},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"vectors3",{get:function(){return this._vectors3},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"vectors4",{get:function(){return this._vectors4},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"matrices",{get:function(){return this._matrices},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"matrices3x3",{get:function(){return this._matrices3x3},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"matrices2x2",{get:function(){return this._matrices2x2},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"vectors3Arrays",{get:function(){return this._vectors3Arrays},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cachedWorldViewMatrix",{get:function(){return this._cachedWorldViewMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"shaderPath",{get:function(){return this._shaderPath},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"renderId",{get:function(){return this._renderId},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"webglVersion",{get:function(){return this._webglVersion},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxTexturesImageUnits",{get:function(){return this._maxTexturesImageUnits},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxVertexUniformVectors",{get:function(){return this._maxVertexUniformVectors},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxFragmentUniformVectors",{get:function(){return this._maxFragmentUniformVectors},enumerable:!0,configurable:!0}),i.prototype.getClassName=function(){return"UniversalShaderMaterial"},Object.defineProperty(i.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!0,configurable:!0}),i.prototype.needAlphaBlending=function(){return!!this._options.needAlphaBlending||!this.linkRefractionWithTransparency&&(this.alpha<1||null!=this.opacityTexture||this._shouldUseAlphaFromAlbedoTexture()||this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled)},i.prototype.needAlphaTesting=function(){return!!this._options.needAlphaTesting||!this.linkRefractionWithTransparency&&(null!=this.albedoTexture&&this.albedoTexture.hasAlpha)},i.prototype._shouldUseAlphaFromAlbedoTexture=function(){return null!=this.albedoTexture&&this.albedoTexture.hasAlpha&&this.useAlphaFromAlbedoTexture},i.prototype.getAlphaTestTexture=function(){return this.albedoTexture},i.prototype._checkAttribute=function(e){this._options.attributes.indexOf(e)===-1&&this._options.attributes.push(e)},i.prototype._checkUniform=function(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)},i.prototype._checkSampler=function(e){this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e)},i.prototype._checkCache=function(e,t,n){return!t||(this._defines.INSTANCES!==n,!1)},i.prototype.convertColorToLinearSpaceToRef=function(e,t){i.convertColorToLinearSpaceToRef(e,t,this.useScalarInLinearSpace)},i.convertColorToLinearSpaceToRef=function(e,t,n){n?(t.r=e.r,t.g=e.g,t.b=e.b):e.toLinearSpaceToRef(t)},i.prototype.setTexture=function(e,t){return this._checkSampler(e),this._textures[e]=t,this},i.prototype.setTextureArray=function(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this},i.prototype.setFloat=function(e,t){return this._checkUniform(e),this._floats[e]=t,this},i.prototype.setFloats=function(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this},i.prototype.setColor3=function(e,t){return this._checkUniform(e),this._colors3[e]=t,this},i.prototype.setColor4=function(e,t){return this._checkUniform(e),this._colors4[e]=t,this},i.prototype.setVector2=function(e,t){return this._checkUniform(e),this._vectors2[e]=t,this},i.prototype.setVector3=function(e,t){return this._checkUniform(e),this._vectors3[e]=t,this},i.prototype.setVector4=function(e,t){return this._checkUniform(e),this._vectors4[e]=t,this},i.prototype.setMatrix=function(e,t){return this._checkUniform(e),this._matrices[e]=t,this},i.prototype.setMatrix3x3=function(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this},i.prototype.setMatrix2x2=function(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this},i.prototype.setArray3=function(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this},i.BindLights=function(t,n,r,a,o,s,l){for(var c=0,u=!1,p=0,h=n._lightSources;p<h.length;p++){var d=h[p];if(e.MaterialHelper.BindLightProperties(d,r,c),this.convertColorToLinearSpaceToRef(d.diffuse,i._scaledAlbedo,o),i._scaledAlbedo.scaleToRef(d.intensity,i._scaledAlbedo),r.setColor4("vLightDiffuse"+c,i._scaledAlbedo,l?d.radius:d.range),a.SPECULARTERM&&(this.convertColorToLinearSpaceToRef(d.specular,i._scaledReflectivity,o),i._scaledReflectivity.scaleToRef(d.intensity,i._scaledReflectivity),r.setColor3("vLightSpecular"+c,i._scaledReflectivity)),t.shadowsEnabled&&(u=e.MaterialHelper.BindLightShadow(d,t,n,c,r,u)),c++,c===s)break}},i.prototype.isReady=function(t,n){if(this.isFrozen&&this._wasPreviouslyReady)return!0;var i=this.getScene(),r=i.getEngine(),a=!1,o=0,s=[];for(this._defines.reset(),this._defines.WEBGL_VERSION=this._webglVersion,this._webglVersion>=1&&s.push("#define WEBGL_API_1"),this._webglVersion>=2&&s.push("#define WEBGL_API_2"),this._webglVersion>=3&&s.push("#define WEBGL_API_3"),this._defines.MAX_TEXTURE_IMAGE_UNITS=this._maxTexturesImageUnits,this._defines.MAX_VERTEX_UNIFORM_VECTORS=this._maxVertexUniformVectors,this._defines.MAX_FRAGMENT_UNIFORM_VECTORS=this._maxFragmentUniformVectors,o=0;o<this._options.defines.length;o++)s.push(this._options.defines[o]);if(this._instance&&this._instance.define(s,t,n),i.lightsEnabled&&!this.disableLighting&&e.MaterialHelper.PrepareDefinesForLights(i,t,this._defines,!0,this.maxSimultaneousLights),!this.checkReadyOnEveryCall&&this._renderId===i.getRenderId()&&this._checkCache(i,t,n))return!0;if(i.texturesEnabled){var l,c=!0;for(l in this._textures){var u=this._textures[l];u&&u.isReady()?(a=!0,s.push("#define "+l+"Def"),this._checkUniform(l+"Infos"),this._checkUniform(l+"Scale"),this._checkUniform(l+"Matrix"),l.indexOf("bumpSampler")>=0&&(this._defines.BUMP=!0)):c=!1}if(!c)return!1;c=!0;for(l in this._textureArrays){s.push("#define "+l+"Def"),l.indexOf("bumpSampler")>=0&&(this._defines.BUMP=!0);for(var p=this._textureArrays[l],o=0;o<p.length;o++){var h=p[o];h&&h.isReady()?a=!0:c=!1}}if(!c)return!1;if(i.getEngine().getCaps().textureLOD&&(this._defines.LODBASEDMICROSFURACE=!0),this.albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled){if(!this.albedoTexture.isReady())return!1;a=!0,this._defines.ALBEDO=!0,s.push("#define albedoSamplerDef")}if(this.ambientTexture&&e.StandardMaterial.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;a=!0,this._defines.AMBIENT=!0,this._defines.AMBIENTINGRAYSCALE=this.useAmbientInGrayScale}if(this.opacityTexture&&e.StandardMaterial.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;a=!0,this._defines.OPACITY=!0,this.opacityTexture.getAlphaFromRGB&&(this._defines.OPACITYRGB=!0)}if(this.reflectionTexture&&e.StandardMaterial.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;switch(this._defines.REFLECTION=!0,this.reflectionTexture.coordinatesMode===e.Texture.INVCUBIC_MODE&&(this._defines.INVERTCUBICMAP=!0),this._defines.REFLECTIONMAP_3D=this.reflectionTexture.isCube,this.reflectionTexture.coordinatesMode){case e.Texture.CUBIC_MODE:case e.Texture.INVCUBIC_MODE:this._defines.REFLECTIONMAP_CUBIC=!0;break;case e.Texture.EXPLICIT_MODE:this._defines.REFLECTIONMAP_EXPLICIT=!0;break;case e.Texture.PLANAR_MODE:this._defines.REFLECTIONMAP_PLANAR=!0;break;case e.Texture.PROJECTION_MODE:this._defines.REFLECTIONMAP_PROJECTION=!0;break;case e.Texture.SKYBOX_MODE:this._defines.REFLECTIONMAP_SKYBOX=!0;break;case e.Texture.SPHERICAL_MODE:this._defines.REFLECTIONMAP_SPHERICAL=!0;break;case e.Texture.EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case e.Texture.FIXED_EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case e.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:this._defines.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0}this.reflectionTexture instanceof e.HDRCubeTexture&&this.reflectionTexture&&(this._defines.USESPHERICALFROMREFLECTIONMAP=!0,this.reflectionTexture.isPMREM&&(this._defines.USEPMREMREFLECTION=!0))}if(this.lightmapTexture&&e.StandardMaterial.LightmapTextureEnabled){if(!this.lightmapTexture.isReady())return!1;a=!0,this._defines.LIGHTMAP=!0,this._defines.USELIGHTMAPASSHADOWMAP=this.useLightmapAsShadowmap}if(this.emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;a=!0,this._defines.EMISSIVE=!0}if(e.StandardMaterial.SpecularTextureEnabled){if(this.metallicTexture){if(!this.metallicTexture.isReady())return!1;a=!0,this._defines.METALLICWORKFLOW=!0,this._defines.METALLICMAP=!0,this._defines.ROUGHNESSSTOREINMETALMAPALPHA=this.useRoughnessFromMetallicTextureAlpha,this._defines.ROUGHNESSSTOREINMETALMAPGREEN=!this.useRoughnessFromMetallicTextureAlpha&&this.useRoughnessFromMetallicTextureGreen,this._defines.METALLNESSSTOREINMETALMAPBLUE=this.useMetallnessFromMetallicTextureBlue,this._defines.AOSTOREINMETALMAPRED=this.useAmbientOcclusionFromMetallicTextureRed}else if(this.reflectivityTexture){if(!this.reflectivityTexture.isReady())return!1;a=!0,this._defines.REFLECTIVITY=!0,this._defines.MICROSURFACEFROMREFLECTIVITYMAP=this.useMicroSurfaceFromReflectivityMapAlpha,this._defines.MICROSURFACEAUTOMATIC=this.useAutoMicroSurfaceFromReflectivityMap}if(this.microSurfaceTexture){if(!this.microSurfaceTexture.isReady())return!1;a=!0,this._defines.MICROSURFACEMAP=!0}}if(i.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&e.StandardMaterial.BumpTextureEnabled&&!this.disableBumpMap){if(!this.bumpTexture.isReady())return!1;a=!0,this._defines.BUMP=!0,s.push("#define bumpSamplerDef"),this.useParallax&&this.albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled&&(this._defines.PARALLAX=!0,this.useParallaxOcclusion&&(this._defines.PARALLAXOCCLUSION=!0)),this.invertNormalMapX&&(this._defines.INVERTNORMALMAPX=!0),this.invertNormalMapY&&(this._defines.INVERTNORMALMAPY=!0),i._mirroredCameraPosition&&(this._defines.INVERTNORMALMAPX=!this._defines.INVERTNORMALMAPX,this._defines.INVERTNORMALMAPY=!this._defines.INVERTNORMALMAPY)}if(this.refractionTexture&&e.StandardMaterial.RefractionTextureEnabled){if(!this.refractionTexture.isReady())return!1;a=!0,this._defines.REFRACTION=!0,this._defines.REFRACTIONMAP_3D=this.refractionTexture.isCube,this.linkRefractionWithTransparency&&(this._defines.LINKREFRACTIONTOTRANSPARENCY=!0),this.refractionTexture instanceof e.HDRCubeTexture&&(this._defines.REFRACTIONMAPINLINEARSPACE=!0,this.refractionTexture.isPMREM&&(this._defines.USEPMREMREFRACTION=!0))}if(this.cameraColorGradingTexture&&e.StandardMaterial.ColorGradingTextureEnabled){if(!this.cameraColorGradingTexture.isReady())return!1;this._defines.CAMERACOLORGRADING=!0}!this.backFaceCulling&&this.twoSidedLighting&&(this._defines.TWOSIDEDLIGHTING=!0)}if(i.clipPlane&&(this._defines.CLIPPLANE=!0),r.getAlphaTesting()&&(this._defines.ALPHATEST=!0),this._shouldUseAlphaFromAlbedoTexture()&&(this._defines.ALPHAFROMALBEDO=!0),this.useEmissiveAsIllumination&&(this._defines.EMISSIVEASILLUMINATION=!0),this.linkEmissiveWithAlbedo&&(this._defines.LINKEMISSIVEWITHALBEDO=!0),this.useLogarithmicDepth&&(this._defines.LOGARITHMICDEPTH=!0),1!=this.cameraContrast&&(this._defines.CAMERACONTRAST=!0),1!=this.cameraExposure&&(this._defines.CAMERATONEMAP=!0),this.cameraColorCurves&&(this._defines.CAMERACOLORCURVES=!0),1==this.overloadedShadeIntensity&&1==this.overloadedShadowIntensity||(this._defines.OVERLOADEDSHADOWVALUES=!0),(this.overloadedMicroSurfaceIntensity>0||this.overloadedEmissiveIntensity>0||this.overloadedReflectivityIntensity>0||this.overloadedAlbedoIntensity>0||this.overloadedAmbientIntensity>0||this.overloadedReflectionIntensity>0)&&(this._defines.OVERLOADEDVALUES=!0),(this.pointsCloud||i.forcePointsCloud)&&(this._defines.POINTSIZE=!0),i.fogEnabled&&t&&t.applyFog&&i.fogMode!==e.Scene.FOGMODE_NONE&&this.fogEnabled&&(this._defines.FOG=!0),e.StandardMaterial.FresnelEnabled&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled||this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled)&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&(this._defines.OPACITYFRESNEL=!0),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._defines.EMISSIVEFRESNEL=!0),this._defines.FRESNEL=!0),this._defines.SPECULARTERM&&this.useSpecularOverAlpha&&(this._defines.SPECULAROVERALPHA=!0),this.usePhysicalLightFalloff&&(this._defines.USEPHYSICALLIGHTFALLOFF=!0),this.useRadianceOverAlpha&&(this._defines.RADIANCEOVERALPHA=!0),(void 0!==this.metallic&&null!==this.metallic||void 0!==this.roughness&&null!==this.roughness)&&(this._defines.METALLICWORKFLOW=!0),t&&(t.isVerticesDataPresent(e.VertexBuffer.NormalKind)||(t.createNormals(!0),e.Tools.Warn("PBRMaterial: Normals have been created for the mesh: "+t.name)),t.isVerticesDataPresent(e.VertexBuffer.NormalKind)&&(this._defines.NORMAL=!0,t.isVerticesDataPresent(e.VertexBuffer.TangentKind)&&(this._defines.TANGENT=!0)),a&&(t.isVerticesDataPresent(e.VertexBuffer.UVKind)&&(this._defines.UV1=!0),t.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&(this._defines.UV2=!0)),t.useVertexColors&&t.isVerticesDataPresent(e.VertexBuffer.ColorKind)&&(this._defines.VERTEXCOLOR=!0,t.hasVertexAlpha&&(this._defines.VERTEXALPHA=!0)),t.useBones&&t.computeBonesUsingShaders&&(this._defines.NUM_BONE_INFLUENCERS=t.numBoneInfluencers,this._defines.BonesPerMesh=t.skeleton.bones.length+1),n&&(this._defines.INSTANCES=!0),t.morphTargetManager)){var d=t.morphTargetManager;this._defines.MORPHTARGETS_NORMAL=d.supportsNormals&&this._defines.NORMAL,this._defines.MORPHTARGETS=d.numInfluencers>0,this._defines.NUM_MORPH_INFLUENCERS=d.numInfluencers}if(!this._defines.isEqual(this._cachedDefines)){this._defines.cloneTo(this._cachedDefines),i.resetCachedMaterial();var f=new e.EffectFallbacks;this._defines.REFLECTION&&f.addFallback(0,"REFLECTION"),this._defines.REFRACTION&&f.addFallback(0,"REFRACTION"),this._defines.REFLECTIVITY&&f.addFallback(0,"REFLECTIVITY"),this._defines.BUMP&&f.addFallback(0,"BUMP"),this._defines.PARALLAX&&f.addFallback(1,"PARALLAX"),this._defines.PARALLAXOCCLUSION&&f.addFallback(0,"PARALLAXOCCLUSION"),this._defines.SPECULAROVERALPHA&&f.addFallback(0,"SPECULAROVERALPHA"),this._defines.FOG&&f.addFallback(1,"FOG"),this._defines.POINTSIZE&&f.addFallback(0,"POINTSIZE"),this._defines.LOGARITHMICDEPTH&&f.addFallback(0,"LOGARITHMICDEPTH"),e.MaterialHelper.HandleFallbacksForShadows(this._defines,f,this.maxSimultaneousLights),this._defines.SPECULARTERM&&f.addFallback(0,"SPECULARTERM"),this._defines.OPACITYFRESNEL&&f.addFallback(1,"OPACITYFRESNEL"),this._defines.EMISSIVEFRESNEL&&f.addFallback(2,"EMISSIVEFRESNEL"),this._defines.FRESNEL&&f.addFallback(3,"FRESNEL"),this._defines.NUM_BONE_INFLUENCERS>0&&f.addCPUSkinningFallback(0,t),this._checkAttribute(e.VertexBuffer.PositionKind),this._defines.NORMAL&&this._checkAttribute(e.VertexBuffer.NormalKind),this._defines.TANGENT&&this._checkAttribute(e.VertexBuffer.TangentKind),this._defines.UV1&&this._checkAttribute(e.VertexBuffer.UVKind),this._defines.UV2&&this._checkAttribute(e.VertexBuffer.UV2Kind),this._defines.VERTEXCOLOR&&this._checkAttribute(e.VertexBuffer.ColorKind),e.MaterialHelper.PrepareAttributesForBones(this._options.attributes,t,this._defines,f),e.MaterialHelper.PrepareAttributesForInstances(this._options.attributes,this._defines),e.MaterialHelper.PrepareAttributesForMorphTargets(this._options.attributes,t,this._defines),e.ColorCurves.PrepareUniforms(this._options.uniforms),e.ColorGradingTexture.PrepareUniformsAndSamplers(this._options.uniforms,this._options.samplers),e.MaterialHelper.PrepareUniformsAndSamplersList(this._options.uniforms,this._options.samplers,this._defines,this.maxSimultaneousLights);var m=this._defines.toString();s.length>0&&(m+=s.join("\n")),this._effect=i.getEngine().createEffect(this._shaderPath,this._options.attributes,this._options.uniforms,this._options.samplers,m,f,this.onCompiled,this.onError,{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:this._defines.NUM_MORPH_INFLUENCERS})}return!!this._effect.isReady()&&(this._renderId=i.getRenderId(),this._wasPreviouslyReady=!0,!0)},i.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null),this.refractionTexture&&this.refractionTexture.isRenderTarget&&this._effect.setTexture("refraction2DSampler",null),t.prototype.unbind.call(this)},i.prototype.bindOnlyWorldMatrix=function(e){var t=this.getScene();this._effect.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),this._effect.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&this._effect.setMatrix("worldViewProjection",e.multiply(t.getTransformMatrix()))},i.prototype.bind=function(t,n){if(this._myScene=this.getScene(),this.bindOnlyWorldMatrix(t),e.MaterialHelper.BindBonesParameters(n,this._effect),this._myScene.getCachedMaterial()!==this){if(this._effect.setMatrix("view",this._myScene.getViewMatrix()),this._effect.setMatrix("projection",this._myScene.getProjectionMatrix()),this._effect.setMatrix("viewProjection",this._myScene.getTransformMatrix()),e.StandardMaterial.FresnelEnabled&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&this._effect.setColor4("opacityParts",new e.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._effect.setColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),this._effect.setColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),this._myScene.texturesEnabled){if(this.albedoTexture&&e.StandardMaterial.DiffuseTextureEnabled&&(this._effect.setTexture("albedoSampler",this.albedoTexture),this._effect.setFloat2("vAlbedoInfos",this.albedoTexture.coordinatesIndex,this.albedoTexture.level),this._effect.setMatrix("albedoMatrix",this.albedoTexture.getTextureMatrix())),this.ambientTexture&&e.StandardMaterial.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat3("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level,this.ambientTextureStrength),this._effect.setMatrix("ambientMatrix",this.ambientTexture.getTextureMatrix())),this.opacityTexture&&e.StandardMaterial.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture.getTextureMatrix())),this.reflectionTexture&&e.StandardMaterial.ReflectionTextureEnabled&&(this._microsurfaceTextureLods.x=Math.round(Math.log(this.reflectionTexture.getSize().width)*Math.LOG2E),this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat2("vReflectionInfos",this.reflectionTexture.level,0),this._defines.USESPHERICALFROMREFLECTIONMAP&&(this._effect.setFloat3("vSphericalX",this.reflectionTexture.sphericalPolynomial.x.x,this.reflectionTexture.sphericalPolynomial.x.y,this.reflectionTexture.sphericalPolynomial.x.z),this._effect.setFloat3("vSphericalY",this.reflectionTexture.sphericalPolynomial.y.x,this.reflectionTexture.sphericalPolynomial.y.y,this.reflectionTexture.sphericalPolynomial.y.z),this._effect.setFloat3("vSphericalZ",this.reflectionTexture.sphericalPolynomial.z.x,this.reflectionTexture.sphericalPolynomial.z.y,this.reflectionTexture.sphericalPolynomial.z.z),this._effect.setFloat3("vSphericalXX",this.reflectionTexture.sphericalPolynomial.xx.x,this.reflectionTexture.sphericalPolynomial.xx.y,this.reflectionTexture.sphericalPolynomial.xx.z),this._effect.setFloat3("vSphericalYY",this.reflectionTexture.sphericalPolynomial.yy.x,this.reflectionTexture.sphericalPolynomial.yy.y,this.reflectionTexture.sphericalPolynomial.yy.z),this._effect.setFloat3("vSphericalZZ",this.reflectionTexture.sphericalPolynomial.zz.x,this.reflectionTexture.sphericalPolynomial.zz.y,this.reflectionTexture.sphericalPolynomial.zz.z),this._effect.setFloat3("vSphericalXY",this.reflectionTexture.sphericalPolynomial.xy.x,this.reflectionTexture.sphericalPolynomial.xy.y,this.reflectionTexture.sphericalPolynomial.xy.z),
this._effect.setFloat3("vSphericalYZ",this.reflectionTexture.sphericalPolynomial.yz.x,this.reflectionTexture.sphericalPolynomial.yz.y,this.reflectionTexture.sphericalPolynomial.yz.z),this._effect.setFloat3("vSphericalZX",this.reflectionTexture.sphericalPolynomial.zx.x,this.reflectionTexture.sphericalPolynomial.zx.y,this.reflectionTexture.sphericalPolynomial.zx.z))),this.emissiveTexture&&e.StandardMaterial.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture.getTextureMatrix())),this.lightmapTexture&&e.StandardMaterial.LightmapTextureEnabled&&(this._effect.setTexture("lightmapSampler",this.lightmapTexture),this._effect.setFloat2("vLightmapInfos",this.lightmapTexture.coordinatesIndex,this.lightmapTexture.level),this._effect.setMatrix("lightmapMatrix",this.lightmapTexture.getTextureMatrix())),e.StandardMaterial.SpecularTextureEnabled&&(this.metallicTexture?(this._effect.setTexture("reflectivitySampler",this.metallicTexture),this._effect.setFloat3("vReflectivityInfos",this.metallicTexture.coordinatesIndex,this.metallicTexture.level,this.ambientTextureStrength),this._effect.setMatrix("reflectivityMatrix",this.metallicTexture.getTextureMatrix())):this.reflectivityTexture&&(this._effect.setTexture("reflectivitySampler",this.reflectivityTexture),this._effect.setFloat3("vReflectivityInfos",this.reflectivityTexture.coordinatesIndex,this.reflectivityTexture.level,1),this._effect.setMatrix("reflectivityMatrix",this.reflectivityTexture.getTextureMatrix())),this.microSurfaceTexture&&(this._effect.setTexture("microSurfaceSampler",this.microSurfaceTexture),this._effect.setFloat2("vMicroSurfaceSamplerInfos",this.microSurfaceTexture.coordinatesIndex,this.microSurfaceTexture.level),this._effect.setMatrix("microSurfaceSamplerMatrix",this.microSurfaceTexture.getTextureMatrix()))),this.bumpTexture&&this._myScene.getEngine().getCaps().standardDerivatives&&e.StandardMaterial.BumpTextureEnabled&&!this.disableBumpMap&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat3("vBumpInfos",this.bumpTexture.coordinatesIndex,1/this.bumpTexture.level,this.parallaxScaleBias),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix())),this.refractionTexture&&e.StandardMaterial.RefractionTextureEnabled){this._microsurfaceTextureLods.y=Math.round(Math.log(this.refractionTexture.getSize().width)*Math.LOG2E);var r=1;this.refractionTexture.isCube?this._effect.setTexture("refractionCubeSampler",this.refractionTexture):(this._effect.setTexture("refraction2DSampler",this.refractionTexture),this._effect.setMatrix("refractionMatrix",this.refractionTexture.getReflectionTextureMatrix()),this.refractionTexture.depth&&(r=this.refractionTexture.depth)),this._effect.setFloat4("vRefractionInfos",this.refractionTexture.level,this.indexOfRefraction,r,this.invertRefractionY?-1:1)}(this.reflectionTexture||this.refractionTexture)&&this._effect.setFloat2("vMicrosurfaceTextureLods",this._microsurfaceTextureLods.x,this._microsurfaceTextureLods.y),this.cameraColorGradingTexture&&e.StandardMaterial.ColorGradingTextureEnabled&&e.ColorGradingTexture.Bind(this.cameraColorGradingTexture,this._effect);var a;if(this._myScene.texturesEnabled)for(a in this._textures){var o=this._textures[a];o&&(this._effect.setTexture(a,o),this._effect.setFloat2(a+"Infos",o.coordinatesIndex,o.level),this._effect.setFloat2(a+"Scale",o.uScale,o.vScale),this._effect.setMatrix(a+"Matrix",o.getTextureMatrix()))}if(this._myScene.texturesEnabled)for(a in this._textureArrays)this._effect.setTextureArray(a,this._textureArrays[a]);for(a in this._floats)this._effect.setFloat(a,this._floats[a]);for(a in this._floatsArrays)this._effect.setArray(a,this._floatsArrays[a]);for(a in this._colors3)this._effect.setColor3(a,this._colors3[a]);for(a in this._colors4){var s=this._colors4[a];this._effect.setFloat4(a,s.r,s.g,s.b,s.a)}for(a in this._vectors2)this._effect.setVector2(a,this._vectors2[a]);for(a in this._vectors3)this._effect.setVector3(a,this._vectors3[a]);for(a in this._vectors4)this._effect.setVector4(a,this._vectors4[a]);for(a in this._matrices)this._effect.setMatrix(a,this._matrices[a]);for(a in this._matrices3x3)this._effect.setMatrix3x3(a,this._matrices3x3[a]);for(a in this._matrices2x2)this._effect.setMatrix2x2(a,this._matrices2x2[a]);for(a in this._vectors3Arrays)this._effect.setArray3(a,this._vectors3Arrays[a])}e.MaterialHelper.BindClipPlane(this._effect,this._myScene),this.pointsCloud&&this._effect.setFloat("pointSize",this.pointSize),this._myScene.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),this._defines.METALLICWORKFLOW?(i._scaledReflectivity.r=void 0===this.metallic?1:this.metallic,i._scaledReflectivity.g=void 0===this.roughness?1:this.roughness,this._effect.setColor4("vReflectivityColor",i._scaledReflectivity,0)):(this.convertColorToLinearSpaceToRef(this.reflectivityColor,i._scaledReflectivity),this._effect.setColor4("vReflectivityColor",i._scaledReflectivity,this.microSurface)),this._effect.setVector3("vEyePosition",this._myScene._mirroredCameraPosition?this._myScene._mirroredCameraPosition:this._myScene.activeCamera.position),this._effect.setColor3("vAmbientColor",this._globalAmbientColor),this.convertColorToLinearSpaceToRef(this.emissiveColor,i._scaledEmissive),this._effect.setColor3("vEmissiveColor",i._scaledEmissive),this.convertColorToLinearSpaceToRef(this.reflectionColor,i._scaledReflection),this._effect.setColor3("vReflectionColor",i._scaledReflection)}this._myScene.getCachedMaterial()===this&&this.isFrozen||(this.convertColorToLinearSpaceToRef(this.albedoColor,i._scaledAlbedo),this._effect.setColor4("vAlbedoColor",i._scaledAlbedo,this.alpha*n.visibility),this._myScene.lightsEnabled&&!this.disableLighting&&e.PBRMaterial.BindLights(this._myScene,n,this._effect,this._defines,this.useScalarInLinearSpace,this.maxSimultaneousLights,this.usePhysicalLightFalloff),e.MaterialHelper.BindFogParameters(this._myScene,n,this._effect),this._defines.NUM_MORPH_INFLUENCERS&&e.MaterialHelper.BindMorphTargetParameters(n,this._effect),this._lightingInfos.x=this.directIntensity,this._lightingInfos.y=this.emissiveIntensity,this._lightingInfos.z=this.environmentIntensity,this._lightingInfos.w=this.specularIntensity,this._effect.setVector4("vLightingIntensity",this._lightingInfos),this._overloadedShadowInfos.x=this.overloadedShadowIntensity,this._overloadedShadowInfos.y=this.overloadedShadeIntensity,this._effect.setVector4("vOverloadedShadowIntensity",this._overloadedShadowInfos),this._cameraInfos.x=this.cameraExposure,this._cameraInfos.y=this.cameraContrast,this._effect.setVector4("vCameraInfos",this._cameraInfos),this.cameraColorCurves&&e.ColorCurves.Bind(this.cameraColorCurves,this._effect),this._overloadedIntensity.x=this.overloadedAmbientIntensity,this._overloadedIntensity.y=this.overloadedAlbedoIntensity,this._overloadedIntensity.z=this.overloadedReflectivityIntensity,this._overloadedIntensity.w=this.overloadedEmissiveIntensity,this._effect.setVector4("vOverloadedIntensity",this._overloadedIntensity),this._effect.setColor3("vOverloadedAmbient",this.overloadedAmbient),this.convertColorToLinearSpaceToRef(this.overloadedAlbedo,this._tempColor),this._effect.setColor3("vOverloadedAlbedo",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedReflectivity,this._tempColor),this._effect.setColor3("vOverloadedReflectivity",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedEmissive,this._tempColor),this._effect.setColor3("vOverloadedEmissive",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedReflection,this._tempColor),this._effect.setColor3("vOverloadedReflection",this._tempColor),this._overloadedMicroSurface.x=this.overloadedMicroSurface,this._overloadedMicroSurface.y=this.overloadedMicroSurfaceIntensity,this._overloadedMicroSurface.z=this.overloadedReflectionIntensity,this._effect.setVector3("vOverloadedMicroSurface",this._overloadedMicroSurface),e.MaterialHelper.BindLogDepth(this._defines,this._effect,this._myScene)),this._afterBind(n),this._myScene=null},i.prototype.getAnimatables=function(){var e=[];this.albedoTexture&&this.albedoTexture.animations&&this.albedoTexture.animations.length>0&&e.push(this.albedoTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&e.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&e.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&e.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&e.push(this.emissiveTexture),this.metallicTexture&&this.metallicTexture.animations&&this.metallicTexture.animations.length>0?e.push(this.metallicTexture):this.reflectivityTexture&&this.reflectivityTexture.animations&&this.reflectivityTexture.animations.length>0&&e.push(this.reflectivityTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&e.push(this.bumpTexture),this.lightmapTexture&&this.lightmapTexture.animations&&this.lightmapTexture.animations.length>0&&e.push(this.lightmapTexture),this.refractionTexture&&this.refractionTexture.animations&&this.refractionTexture.animations.length>0&&e.push(this.refractionTexture),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.animations&&this.cameraColorGradingTexture.animations.length>0&&e.push(this.cameraColorGradingTexture);var t;for(t in this._textures){var n=this._textures[t];n&&e.push(n)}for(t in this._textureArrays)for(var i=this._textureArrays[t],r=0;r<i.length;r++){var n=i[r];n&&e.push(n)}return e},i.prototype.dispose=function(e,n){if(n){this.albedoTexture&&(this.albedoTexture.dispose(),this.albedoTexture=null),this.ambientTexture&&(this.ambientTexture.dispose(),this.ambientTexture=null),this.opacityTexture&&(this.opacityTexture.dispose(),this.opacityTexture=null),this.reflectionTexture&&(this.reflectionTexture.dispose(),this.reflectionTexture=null),this.emissiveTexture&&(this.emissiveTexture.dispose(),this.emissiveTexture=null),this.metallicTexture&&(this.metallicTexture.dispose(),this.metallicTexture=null),this.reflectivityTexture&&(this.reflectivityTexture.dispose(),this.reflectivityTexture=null),this.bumpTexture&&(this.bumpTexture.dispose(),this.bumpTexture=null),this.lightmapTexture&&(this.lightmapTexture.dispose(),this.lightmapTexture=null),this.refractionTexture&&(this.refractionTexture.dispose(),this.refractionTexture=null),this.cameraColorGradingTexture&&(this.cameraColorGradingTexture.dispose(),this.cameraColorGradingTexture=null);var i;for(i in this._textures){var r=this._textures[i];r&&r.dispose(),this._textures[i]=null}for(i in this._textureArrays)for(var a=this._textureArrays[i],o=0;o<a.length;o++)a[o].dispose()}this._textures={},this._dispose&&this._dispose(),t.prototype.dispose.call(this,e,n)},i.prototype.clone=function(t){var n=this;return e.SerializationHelper.Clone(function(){return new e.UniversalShaderMaterial(t,n.getScene(),n._shaderPath,n._options,n._controller)},this)},i.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="BABYLON.UniversalShaderMaterial",t.options=this._options,t.controller=this._controller,t.shaderPath=this._shaderPath;var n;t.textures={};for(n in this._textures){var i=this._textures[n];i&&(t.textures[n]=i.serialize())}t.textureArrays={};for(n in this._textureArrays){t.textureArrays[n]=[];for(var r=this._textureArrays[n],a=0;a<r.length;a++)t.textureArrays[n].push(r[a].serialize())}t.floats={};for(n in this._floats)t.floats[n]=this._floats[n];t.floatArrays={};for(n in this._floatsArrays)t.floatArrays[n]=this._floatsArrays[n];t.colors3={};for(n in this._colors3)t.colors3[n]=this._colors3[n].asArray();t.colors4={};for(n in this._colors4)t.colors4[n]=this._colors4[n].asArray();t.vectors2={};for(n in this._vectors2)t.vectors2[n]=this._vectors2[n].asArray();t.vectors3={};for(n in this._vectors3)t.vectors3[n]=this._vectors3[n].asArray();t.vectors4={};for(n in this._vectors4)t.vectors4[n]=this._vectors4[n].asArray();t.matrices={};for(n in this._matrices)t.matrices[n]=this._matrices[n].asArray();t.matrices3x3={};for(n in this._matrices3x3)t.matrices3x3[n]=this._matrices3x3[n];t.matrices2x2={};for(n in this._matrices2x2)t.matrices2x2[n]=this._matrices2x2[n];t.vectors3Arrays={};for(n in this._vectors3Arrays)t.vectors3Arrays[n]=this._vectors3Arrays[n];return t},i.Parse=function(t,n,i){var r,a=e.SerializationHelper.Parse(function(){return new e.UniversalShaderMaterial(t.name,n,t.shaderPath,t.options,t.controller)},t,n,i);for(r in t.textures){var o=t.textures[r];o&&a.setTexture(r,e.Texture.Parse(o,n,i))}for(r in t.textureArrays){for(var s=t.textureArrays[r],l=new Array,c=0;c<s.length;c++)l.push(e.Texture.Parse(s[c],n,i));a.setTextureArray(r,l)}for(r in t.floats)a.setFloat(r,t.floats[r]);for(r in t.floatsArrays)a.setFloats(r,t.floatsArrays[r]);for(r in t.colors3)a.setColor3(r,e.Color3.FromArray(t.colors3[r]));for(r in t.colors4)a.setColor4(r,e.Color4.FromArray(t.colors4[r]));for(r in t.vectors2)a.setVector2(r,e.Vector2.FromArray(t.vectors2[r]));for(r in t.vectors3)a.setVector3(r,e.Vector3.FromArray(t.vectors3[r]));for(r in t.vectors4)a.setVector4(r,e.Vector4.FromArray(t.vectors4[r]));for(r in t.matrices)a.setMatrix(r,e.Matrix.FromArray(t.matrices[r]));for(r in t.matrices3x3)a.setMatrix3x3(r,t.matrices3x3[r]);for(r in t.matrices2x2)a.setMatrix2x2(r,t.matrices2x2[r]);for(r in t.vectors3Arrays)a.setArray3(r,t.vectors3Arrays[r]);return a},i.prototype.registerInstance=function(e){e.getScene().registerBeforeRender(e._before),e.getScene().registerAfterRender(e._after)},i.prototype.updateInstance=function(e){e._started?e._instance&&e._instance.update():(e._instance&&e._instance.start(),e._started=!0)},i.prototype.afterInstance=function(e){e._started&&e._instance&&e._instance.after()},i.prototype.disposeInstance=function(e){e.getScene().unregisterBeforeRender(e._before),e.getScene().unregisterAfterRender(e._after),e._instance&&e._instance.dispose(),e._started=!1,e._register=null,e._before=null,e._after=null,e._dispose=null},i}(e.Material);i._scaledAlbedo=new e.Color3,i._scaledReflectivity=new e.Color3,i._scaledEmissive=new e.Color3,i._scaledReflection=new e.Color3,__decorate([e.serialize()],i.prototype,"directIntensity",void 0),__decorate([e.serialize()],i.prototype,"emissiveIntensity",void 0),__decorate([e.serialize()],i.prototype,"environmentIntensity",void 0),__decorate([e.serialize()],i.prototype,"specularIntensity",void 0),__decorate([e.serialize()],i.prototype,"disableBumpMap",void 0),__decorate([e.serialize()],i.prototype,"overloadedShadowIntensity",void 0),__decorate([e.serialize()],i.prototype,"overloadedShadeIntensity",void 0),__decorate([e.serialize()],i.prototype,"cameraExposure",void 0),__decorate([e.serialize()],i.prototype,"cameraContrast",void 0),__decorate([e.serializeAsTexture()],i.prototype,"cameraColorGradingTexture",void 0),__decorate([e.serializeAsColorCurves()],i.prototype,"cameraColorCurves",void 0),__decorate([e.serializeAsColor3()],i.prototype,"overloadedAmbient",void 0),__decorate([e.serialize()],i.prototype,"overloadedAmbientIntensity",void 0),__decorate([e.serializeAsColor3()],i.prototype,"overloadedAlbedo",void 0),__decorate([e.serialize()],i.prototype,"overloadedAlbedoIntensity",void 0),__decorate([e.serializeAsColor3()],i.prototype,"overloadedReflectivity",void 0),__decorate([e.serialize()],i.prototype,"overloadedReflectivityIntensity",void 0),__decorate([e.serializeAsColor3()],i.prototype,"overloadedEmissive",void 0),__decorate([e.serialize()],i.prototype,"overloadedEmissiveIntensity",void 0),__decorate([e.serializeAsColor3()],i.prototype,"overloadedReflection",void 0),__decorate([e.serialize()],i.prototype,"overloadedReflectionIntensity",void 0),__decorate([e.serialize()],i.prototype,"overloadedMicroSurface",void 0),__decorate([e.serialize()],i.prototype,"overloadedMicroSurfaceIntensity",void 0),__decorate([e.serializeAsTexture()],i.prototype,"albedoTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"ambientTexture",void 0),__decorate([e.serialize()],i.prototype,"ambientTextureStrength",void 0),__decorate([e.serializeAsTexture()],i.prototype,"opacityTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"reflectionTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"emissiveTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"reflectivityTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"metallicTexture",void 0),__decorate([e.serialize()],i.prototype,"metallic",void 0),__decorate([e.serialize()],i.prototype,"roughness",void 0),__decorate([e.serializeAsTexture()],i.prototype,"microSurfaceTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"bumpTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"lightmapTexture",void 0),__decorate([e.serializeAsTexture()],i.prototype,"refractionTexture",void 0),__decorate([e.serializeAsColor3("ambient")],i.prototype,"ambientColor",void 0),__decorate([e.serializeAsColor3("albedo")],i.prototype,"albedoColor",void 0),__decorate([e.serializeAsColor3("reflectivity")],i.prototype,"reflectivityColor",void 0),__decorate([e.serializeAsColor3("reflection")],i.prototype,"reflectionColor",void 0),__decorate([e.serializeAsColor3("emissive")],i.prototype,"emissiveColor",void 0),__decorate([e.serialize()],i.prototype,"microSurface",void 0),__decorate([e.serialize()],i.prototype,"indexOfRefraction",void 0),__decorate([e.serialize()],i.prototype,"invertRefractionY",void 0),__decorate([e.serializeAsFresnelParameters()],i.prototype,"opacityFresnelParameters",void 0),__decorate([e.serializeAsFresnelParameters()],i.prototype,"emissiveFresnelParameters",void 0),__decorate([e.serialize()],i.prototype,"linkRefractionWithTransparency",void 0),__decorate([e.serialize()],i.prototype,"linkEmissiveWithAlbedo",void 0),__decorate([e.serialize()],i.prototype,"useLightmapAsShadowmap",void 0),__decorate([e.serialize()],i.prototype,"useEmissiveAsIllumination",void 0),__decorate([e.serialize()],i.prototype,"useAlphaFromAlbedoTexture",void 0),__decorate([e.serialize()],i.prototype,"useSpecularOverAlpha",void 0),__decorate([e.serialize()],i.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),__decorate([e.serialize()],i.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),__decorate([e.serialize()],i.prototype,"useRoughnessFromMetallicTextureGreen",void 0),__decorate([e.serialize()],i.prototype,"useMetallnessFromMetallicTextureBlue",void 0),__decorate([e.serialize()],i.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),__decorate([e.serialize()],i.prototype,"useAmbientInGrayScale",void 0),__decorate([e.serialize()],i.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),__decorate([e.serialize()],i.prototype,"useScalarInLinearSpace",void 0),__decorate([e.serialize()],i.prototype,"usePhysicalLightFalloff",void 0),__decorate([e.serialize()],i.prototype,"useRadianceOverAlpha",void 0),__decorate([e.serialize()],i.prototype,"useParallax",void 0),__decorate([e.serialize()],i.prototype,"useParallaxOcclusion",void 0),__decorate([e.serialize()],i.prototype,"parallaxScaleBias",void 0),__decorate([e.serialize()],i.prototype,"disableLighting",void 0),__decorate([e.serialize()],i.prototype,"maxSimultaneousLights",void 0),__decorate([e.serialize()],i.prototype,"invertNormalMapX",void 0),__decorate([e.serialize()],i.prototype,"invertNormalMapY",void 0),__decorate([e.serialize()],i.prototype,"twoSidedLighting",void 0),__decorate([e.serialize()],i.prototype,"useLogarithmicDepth",null),e.UniversalShaderMaterial=i}(BABYLON||(BABYLON={}));